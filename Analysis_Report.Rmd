---
title: "India Air Quality Index - Data Analysis"
author: "Rishi Dey Chowdhury"
date: "7/9/2021"
output: html_document
keep_md: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(lubridate)
library(modelr)
library(psych)
library(car)
library(GGally)
library(ggpubr)
library(ggrepel)
library(purrr)
library(knitr)
library(kableExtra)
library(stringr)
library(viridis)
library(formattable)
library(skimr)
library(moderndive)
library(infer)
#library(fitdistrplus)
library(pander)
library(stargazer)
library(forcats)
library(broom)
library(jtools)
library(huxtable)
library(broom.mixed)
options(dplyr.summarise.inform = FALSE)
```

```{r raw_data, cache=TRUE, include=FALSE}
# Importing my data sets
air_data_world <- read_csv("E:\\MY COLLEGE\\ISI KOLKATA\\1ST YEAR\\PROJECTS\\2ND SEM\\STATISTICAL METHODS II\\Air Quality Index\\all_air_data.csv", comment = '#')
air_data_world
station_list <- readxl::read_excel("E:\\MY COLLEGE\\ISI KOLKATA\\1ST YEAR\\PROJECTS\\2ND SEM\\STATISTICAL METHODS II\\Air Quality Index\\Station_List.xlsx", skip = 1)
```

```{r processed_data, cache=TRUE, dependson="raw_data", include=FALSE}
# Separating out the date column for easier analysis
air_data_world <- air_data_world %>%
  mutate(Year = year(Date), Month = month(Date), Day = day(Date)) %>%
  select(Year, Month, Day, Country, City, Specie, count, min, max, median, variance)

# Filtering Data relevant to INDIA
air_data_india <- air_data_world %>%
  filter(Country == "IN")
air_data_india <- air_data_india %>%
  select(Year:Day, City:variance)
air_data_india
air_data_india_withDate <- air_data_world %>%
  filter(Country =="IN")

# Changing some basic flaws in data
correct <- function(x) return(ifelse(x == "wind speed", "wind-speed", x))
air_data_india$Specie <- correct(air_data_india$Specie)
correct <- function(x) return(ifelse(x == "wind gust", "wind-gust", x))
air_data_india$Specie <- correct(air_data_india$Specie)
air_data_india <- air_data_india %>%
  filter(Specie != "wd")
correct <- function(x) return(ifelse(x == "New Delhi", "Delhi", x))
air_data_india$City <- correct(air_data_india$City)

# Arranging the Data according to Year
air_data_india <- air_data_india %>%
  arrange(Year, Month, Day)
air_data_india

# Trying to separate the column Specie for easier analysis -- widening the data
spec1 <- air_data_india %>%
  build_wider_spec(names_from = Specie, values_from = c(count, min, max, median, variance, Year, Month, Day, City))
spec1
# Separate based on Specie
air_data_india_Specie <- air_data_india %>%
  group_by(Specie) %>%
  mutate(row = row_number()) %>%
  pivot_wider_spec(spec1) %>%
  select(-row) %>%
  select(contains("Year"), contains("Month"), contains("Day"), contains("City"), everything())
air_data_india_Specie

# Separate based on City
spec2 <- air_data_india %>%
  build_wider_spec(names_from = City, values_from = c(Specie, count, min, max, median, variance, Year, Month, Day, City))
spec2

air_data_india_City <- air_data_india %>%
  group_by(City) %>%
  mutate(row = row_number()) %>%
  pivot_wider_spec(spec2) %>%
  select(-row) %>%
  select(contains("Year"), contains("Month"), contains("Day"), contains("City"), everything())
air_data_india_City

# Filtering out the pollutants only
air_data_india_pollutants <- air_data_india %>%
  filter(Specie %in% c('pm25', 'pm10', 'o3', 'so2', 'no2', 'co'))

# Filtering out the non-pollutants
air_data_india_nonpollutants <- air_data_india %>%
  filter(!(Specie %in% c('pm25', 'pm10', 'o3', 'so2', 'no2', 'co')))

# What Columns are present in my Data?
colnames(air_data_india)
unique(air_data_india$City)
unique(air_data_india$Specie)

# Making List of Stations.
colnames(station_list) <- c("Sl.No.State", "State", "Sl.No.City", "City", "Sl.No.Station", "Station")
station_list <- station_list %>%
  select(State, City, Station) %>%
  fill(State) %>%
  fill(City) %>%
  fill(Station)
station_list

station_list <- station_list %>%
  filter(City %in% unique(air_data_india$City)) %>%
  group_by(State, City) %>%
  summarise("Number of Stations" = n())
```

# INTRODUCTION

In this Data Analysis Project, I am going to work with **Air Quality Index (AQI) Data of India**. I will be using several Statistical Tools to Analyze the Data which includes Exploratory Data Analysis, Techniques and methodologies used for Inference and Modelling.

### MOTIVE

-   To understand the relationship that holds between different parameters which we measure as a part of AQI Data of India.

-   To find out if COVID-19 Nation-wise Lockdowns, Social Distancing and Closure of Industries, Factories and Suspension of movement via private vehicles and public transport had a significant impact on India's AQI.

## UNDERSTANDING THE DATA

Let's take a look at the Data

```{r}
kable(head(air_data_india), caption = "First few rows of the Air Quality Index Data") %>%
  kable_styling(position = "center")
kable(tail(air_data_india), caption = "Last few rows of the Air Quality Index Data") %>%
  kable_styling(position = "center")
```

-   This Dataset contains `r nrow(air_data_india)` rows and `r ncol(air_data_india)` columns.

-   The Year ranges from 2014 to 2021 (till June), with observations recorded on each of the 30 /31 days of the month for 12 months for the last 3 years.

-   The Data is generated from the `r length(unique(air_data_india$City))` cities from various Stations located near that Cities. The Cities include:

```{r City_Stations_List}
kable(station_list, caption = "City Stations") %>%
  kable_styling(position = "center")
```

-   The parameters which we measure at the different Stations are given under the Specie Column and it includes -

```{r Specie_description}
Specie_description <- tibble(
  Parameters = unique(air_data_india$Specie),
  Description = c(
    "Particle pollution/particulate matter(particles less than or equal to 2.5 micrometers in diameter)",
    "Particle pollution/particulate matter(particles less than or equal to 10 micrometers in diameter)",
    "Ground-level ozone",
    "Sulphur dioxide",
    "Nitrogen dioxide",
    "Carbon Monoxide",
    "Temperature",
    "Air Pressure",
    "Wind Gust/Force",
    "Relative Humidity",
    "Wind Speed",
    "Dew Point",
    "Precipitation"
  ),
  Units = c("micrograms/cubic meter","micrograms/cubic meter","micrograms/cubic meter","micrograms/cubic meter","micrograms/cubic meter","miligrams/cubic meter","Celcius","Torr","kmph","No Units","kmph","Celcius","milimeters")
)
kable(Specie_description, caption = "Specie Description") %>%
  kable_styling(position = "center")
```

AQI is a comparable and communicable way of measuring the parameters in the Air. It is calculated when atleast 3 of the top 6 parameter's data is available of which one must be pm10 or pm25.

-   It also helps in identifying faulty standards and inadequate monitoring programmes.

-   AQI helps in analysing the change in air quality (improvement or degradation).

-   Comparing air quality conditions at different locations/cities.

-   It can be easily interpreted by anyone, without knowing about background details.

```{r AQI_Info}
AQI_Info <- tibble(
  "AQI Values" = c(
    "0-50",
    "51-100",
    "101-150",
    "151-200",
    "201-300",
    "301-500"
  ),
  "Level of Health Concern" = c(
    "Good",
    "Moderate",
    "Unhealthy for sensitive group",
    "Unhealthy",
    "Very Unhealthy",
    "Hazardous"
  )
)
kable(AQI_Info, caption = "Significance of the AQI Values") %>%
  kable_styling(position = "center")
```

In further Analysis we will refer *pm25, pm10, o3, so2, no2 and co2 as pollutants* and the *remaining weather parameters as non-pollutants*.

## TOP CITY STATIONS

Here we look at *which city records how many observations per year*.

```{r obsv_per_station, fig.asp=0.618, fig.width=12}
obsv_per_station <- air_data_india %>%
  group_by(Year, City) %>%
  count() %>%
  arrange(Year, desc(n)) %>%
  spread(key = Year, value = n) %>%
  arrange(desc(`2019`, `2020`, `2021`))

air_data_india %>%
  group_by(Year, City) %>%
  count() %>%
  filter(Year %in% c("2021", "2020", "2019", "2018")) %>%
  ggplot(aes(City, n, fill = City)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~Year) +
  coord_flip() +
  labs(
    y = "Number of Observations Recorded",
    x = "Cities"
  ) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 3,
      override.aes = list(size = 3)
    )
  ) + ggtitle("Observations Recorded Per Station Every Year") +
  scale_color_viridis(discrete = TRUE)
```

It seems **Delhi is the most monitored cities among the others**. We see all the other stations have almost equal number of observations per year. Our data seems to have lot of missing values for the year 2018 and the years before that; Hence we will only consider the data of the year 2019, 2020 and 2021.

Speculating on the reason *why Delhi is so heavily monitored* we look at *how the Average Median AQI Levels of pollutants at each city every year*.

```{r avg_median_per_year_per_station, fig.asp=0.618, fig.width=12}
avg_median_per_year_per_station <- air_data_india_pollutants %>%
  group_by(Year, City) %>%
  summarise(Median = mean(median)) %>%
  arrange(desc(Year, Median)) %>%
  spread(key = Year, value = Median) %>%
  arrange(desc(`2021`, `2020`, `2019`))

air_data_india_pollutants %>%
  group_by(Year, City) %>%
  summarise(Median = mean(median)) %>%
  arrange(desc(Year, Median)) %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018))) %>%
  ggplot(aes(City, Median, fill = City)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~Year) +
  coord_flip() +
  labs(
    y = "Average Median AQI Levels of Pollutants"
  ) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 3,
      override.aes = list(size = 3)
    )
  ) + ggtitle("Average Median AQI Levels of Pollutants Each City Every Year") +
  scale_color_viridis(discrete = TRUE)
```

Indeed it is clearly visible that **Delhi's AQI Levels of Pollutants is higher** than all other cities. This makes Delhi our city of main focus in all the further analysis. Every city owing to it's location at different parts of the country, different development status, different population, different local weather conditions has different measured values of AQI. So, it makes sense to look at them separately. So, whenever we will look at City-wise Analysis, we will look at these Cities as our **Top 4 Cities** - **Delhi, Muzaffarnagar, Kolkata, Mumbai.**

# VISUAL OVERVIEW

Here we will take a visual tour of the Data through Exploratory Data Analysis.

-   Let's see the AQI Levels in the Top 4 across all 3 measures - Max, Median and Min splitting the year into two halves.

```{r Yearly_Station_Bar_Month_Split, fig.asp=1, fig.width=12}
top_cities <- c("Delhi", "Muzaffarnagar", "Kolkata", "Mumbai")

p1 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018))) %>%
  filter(City %in% top_cities, Month %in% c(1,2,3,4,5,6)) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  group_by(Year, City, Measure) %>%
  summarise(Mean_AQI = mean(AQI)) %>%
  arrange(desc(Year, Mean_AQI)) %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(City, Mean_AQI)) +
  geom_bar(aes(fill = Measure), position = "dodge", stat = "identity") +
  labs(
    y = "Average AQI Levels",
    x = element_blank()
  ) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~Year) + ggtitle("Average AQI Levels Across Our Top 4 Cities - First Half of Year") +
  theme(legend.position = "None") +
  scale_fill_viridis(discrete = TRUE)

p2 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018))) %>%
  filter(City %in% top_cities, !(Month %in% c(1,2,3,4,5,6))) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  group_by(Year, City, Measure) %>%
  summarise(Mean_AQI = mean(AQI)) %>%
  arrange(desc(Year, Mean_AQI)) %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(City, Mean_AQI)) +
  geom_bar(aes(fill = Measure), position = "dodge", stat = "identity") +
  labs(
    y = "Average AQI Levels"
  ) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~Year) + ggtitle("Average AQI Levels Across Our Top 4 Cities - Last Half of Year") +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1,
      override.aes = list(size = 3)
    )
  )  +
  scale_fill_viridis(discrete = TRUE)

ggarrange(p1, p2, nrow = 2)
```

The first bit of observation is the **Median & Min AQI Levels of all 4 cities have dropped in 2020 and 2021 is similar to 2019**. But the **Max AQI Levels have increased in 2020 and even more in 2021** even though we had so many restrictions in 2020!

```{r City_AQI_Box, fig.asp=1, fig.width=12}
p1 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018)), City %in% top_cities, Month %in% c(1,2,3,4,5,6)) %>%
  mutate(Year = as.character(Year)) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  group_by(Year, Month, Day, City, Measure) %>%
  summarise(AQI = mean(AQI, na.rm = TRUE)) %>%
  ggplot(aes(City, AQI, fill =Year, color = Measure)) +
  geom_boxplot(outlier.shape = NA) + 
  #coord_cartesian(ylim = c(0, 200)) +
  labs(y = "Average AQI Levels", fill = "Year") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  )  + ggtitle("Average AQI Levels Across Our Top 4 Cities - First Half of Year") + 
  scale_fill_viridis(discrete = TRUE)

p2 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018)), City %in% top_cities, !(Month %in% c(1,2,3,4,5,6))) %>%
  mutate(Year = as.character(Year)) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  group_by(Year, Month, Day, City, Measure) %>%
  summarise(AQI = mean(AQI, na.rm = TRUE)) %>%
  ggplot(aes(City, AQI, fill =Year, color = Measure)) +
  geom_boxplot(outlier.shape = NA) + 
  #coord_cartesian(ylim = c(0, 250)) +
  labs(y = "Average AQI Levels", fill = "Year") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  )  + ggtitle("Average AQI Levels Across Our Top 4 Cities - Last Half of Year") +
  scale_fill_viridis(discrete = TRUE)

ggarrange(p1, p2, nrow = 2)
```

In the first half of the year 2020 Min and Median AQI Levels have dropped whereas in the second half of the year it either increased or remained same as that of 2019. 2021's observed values are pretty much the same as that of 2019 if not more. Max AQI Levels kept rising across the years irrespective of the part of the years. **The spread(Variance) of the resp. measures look the same across the years**.

-   Let's take a look at the pollutant-wise Levels in our Top 4 Cities.

```{r Specie_Yearly_Viz, fig.asp=1, fig.width=12}
Yearly_Specie <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018))) %>%
  group_by(Year, Specie) %>%
  summarise(Avg_Min = mean(min), Avg_Median = mean(median), Avg_Max = mean(max))

Yearly_Specie_1 <- Yearly_Specie %>%
  gather(Avg_Min, Avg_Median, Avg_Max, key = "Measure", value = "AQI") %>%
  spread(key = Specie, value = AQI)

p1 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018)), Month %in% c(1,2,3,4,5,6), City %in% top_cities) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(Specie, AQI, fill = Year)) +
  geom_boxplot(outlier.shape = NA) +
  coord_cartesian(ylim = c(0,550)) +
  labs(fill = "Year")+
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~City, scales = "free") +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  ) + ggtitle("Average Levels of Pollutants Across Our Top 4 Cities - First Half of Year") +
  scale_fill_viridis(discrete = TRUE)

p2 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018)), !(Month %in% c(1,2,3,4,5,6)), City %in% top_cities) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(Specie, AQI, fill = Year)) +
  geom_boxplot(outlier.shape = NA) +
  coord_cartesian(ylim = c(0,500)) +
  labs(fill = "Year")+
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~City, scales = "free") +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  ) + ggtitle("Average Levels of Pollutants Across Our Top 4 Cities - Last Half of Year") +
  scale_fill_viridis(discrete = TRUE)

ggarrange(p1, p2, nrow = 2)
```

Here we see an interesting effect of Lockdowns. **All the pollutants have decreased considerably in the First half of 2020 whereas in the Second half it has bumped up again to match the Levels of 2019 or even more! While the Levels of 2021 & 2019 are very similar**.
