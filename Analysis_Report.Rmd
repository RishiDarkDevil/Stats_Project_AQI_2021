---
title: "India Air Quality Index - Data Analysis"
author: "Rishi Dey Chowdhury"
date: "7/9/2021"
output: html_document
keep_md: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(lubridate)
library(modelr)
library(psych)
library(car)
library(GGally)
library(ggpubr)
library(ggrepel)
library(purrr)
library(knitr)
library(kableExtra)
library(stringr)
library(viridis)
library(formattable)
#library(skimr)
library(moderndive)
library(infer)
#library(fitdistrplus)
library(pander)
library(stargazer)
library(forcats)
library(broom)
library(jtools)
library(huxtable)
library(broom.mixed)
options(dplyr.summarise.inform = FALSE)
```

```{r raw_data, cache=TRUE, include=FALSE}
# Importing my data sets
air_data_world <- read_csv("E:\\MY COLLEGE\\ISI KOLKATA\\1ST YEAR\\PROJECTS\\2ND SEM\\STATISTICAL METHODS II\\Air Quality Index\\all_air_data.csv", comment = '#')

station_list <- readxl::read_excel("E:\\MY COLLEGE\\ISI KOLKATA\\1ST YEAR\\PROJECTS\\2ND SEM\\STATISTICAL METHODS II\\Air Quality Index\\Station_List.xlsx", skip = 1)
```

```{r processed_data, cache=TRUE, dependson="raw_data", include=FALSE}
# Separating out the date column for easier analysis
air_data_world <- air_data_world %>%
  mutate(Year = year(Date), Month = month(Date), Day = day(Date)) %>%
  select(Year, Month, Day, Country, City, Specie, count, min, max, median, variance)

# Filtering Data relevant to INDIA
air_data_india <- air_data_world %>%
  filter(Country == "IN")
air_data_india <- air_data_india %>%
  select(Year:Day, City:variance)

rm(air_data_world)

# Changing some basic flaws in data
correct <- function(x) return(ifelse(x == "wind speed", "wind-speed", x))
air_data_india$Specie <- correct(air_data_india$Specie)
correct <- function(x) return(ifelse(x == "wind gust", "wind-gust", x))
air_data_india$Specie <- correct(air_data_india$Specie)
air_data_india <- air_data_india %>%
  filter(Specie != "wd")
correct <- function(x) return(ifelse(x == "New Delhi", "Delhi", x))
air_data_india$City <- correct(air_data_india$City)

# Arranging the Data according to Year
air_data_india <- air_data_india %>%
  arrange(Year, Month, Day)

# Trying to separate the column Specie for easier analysis -- widening the data
spec1 <- air_data_india %>%
  build_wider_spec(names_from = Specie, values_from = c(count, min, max, median, variance, Year, Month, Day, City))
# Separate based on Specie
air_data_india_Specie <- air_data_india %>%
  group_by(Specie) %>%
  mutate(row = row_number()) %>%
  pivot_wider_spec(spec1) %>%
  select(-row) %>%
  select(contains("Year"), contains("Month"), contains("Day"), contains("City"), everything())

# Separate based on City
spec2 <- air_data_india %>%
  build_wider_spec(names_from = City, values_from = c(Specie, count, min, max, median, variance, Year, Month, Day, City))

air_data_india_City <- air_data_india %>%
  group_by(City) %>%
  mutate(row = row_number()) %>%
  pivot_wider_spec(spec2) %>%
  select(-row) %>%
  select(contains("Year"), contains("Month"), contains("Day"), contains("City"), everything())

# Filtering out the pollutants only
air_data_india_pollutants <- air_data_india %>%
  filter(Specie %in% c('pm25', 'pm10', 'o3', 'so2', 'no2', 'co'))

# Filtering out the non-pollutants
air_data_india_nonpollutants <- air_data_india %>%
  filter(!(Specie %in% c('pm25', 'pm10', 'o3', 'so2', 'no2', 'co')))

# Making List of Stations.
colnames(station_list) <- c("Sl.No.State", "State", "Sl.No.City", "City", "Sl.No.Station", "Station")
station_list <- station_list %>%
  select(State, City, Station) %>%
  fill(State) %>%
  fill(City) %>%
  fill(Station)

station_list <- station_list %>%
  filter(City %in% unique(air_data_india$City)) %>%
  group_by(State, City) %>%
  summarise("Number of Stations" = n())

# Some preliminary cleaning
air_data_india_All_Specie_Daily_AQI_formulated <- air_data_india %>%
  group_by(Year, Month, Day,  Specie, City) %>%
  summarise(Min = mean(min, na.rm = TRUE), Median = mean(median, na.rm = TRUE), Max = mean(max, na.rm = TRUE), Var = mean(variance, na.rm = TRUE)) %>%
  gather(Min, Median, Max, Var, key = "Measure", value = "AQI") %>%
  spread(key = Specie, value = AQI) %>%
  filter(Year %in% c(2019, 2020, 2021), Measure != "Var") %>%
  group_by(Year, Month, Day, City) %>%
  mutate(so2 = mean(so2, na.rm = TRUE), no2 = mean(no2, na.rm = TRUE), co = mean(co, na.rm = TRUE), o3 = mean(o3, na.rm = TRUE), pm10 = mean(pm10, na.rm = TRUE), pm25 = mean(pm25, na.rm = TRUE), dew = mean(dew, na.rm = TRUE), humidity = mean(humidity, na.rm = TRUE), pessure = mean(pressure, na.rm = TRUE), temperature = mean(temperature, na.rm = TRUE), `wind-speed` = mean(`wind-speed`, na.rm = TRUE)) %>%
  mutate(AQI = max(co, no2, o3, so2, pm10, pm25, na.rm = TRUE))

air_data_india_All_Specie_Daily_AQI_formulated <- air_data_india_All_Specie_Daily_AQI_formulated %>%
  filter(City %in% c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai", "Lucknow", "Patna", "Chandigarh", "Gandhinagar", "Jaipur")) %>%
  mutate(Year = as.character(Year)) %>%
  filter(!is.na(so2)) %>%
  filter(!is.na(no2)) %>%
  filter(!is.na(co)) %>%
  filter(!is.na(o3)) %>%
  filter(!is.na(pm25)) %>%
  filter(!(is.na(pm10) & City == "Chandigarh")) %>%
  filter(!(is.na(pm10) & City == "Gandhinagar")) %>%
  filter(!(City == "Mumbai" & temperature < 15)) %>%
  filter(!((City == "Jaipur" & o3 > 100) | (City == "Lucknow" & o3 > 100) | (City == "Chandigarh" & o3 > 100))) %>%
  filter(!((City == "Mumbai" & co > 50))) %>%
  filter(!((City == "Patna" & no2 > 50))) %>%
  filter(!((City == "Patna" & so2 > 100))) %>%
  filter((humidity >= 20 & humidity <= 100) & (dew >= 0 & dew <= 50) & (temperature >= 0 & temperature <= 55) & (pressure >= 600)) %>%
  filter(Measure == "Median") %>%
  select(-c(Measure, precipitation, `wind-gust`))
```

# INTRODUCTION

In this Data Analysis Project, I am going to work with **Air Quality Index (AQI) Data of India**. I will be using several Statistical Tools to Analyze the Data which includes Exploratory Data Analysis, Techniques and methodologies used for Inference and Modelling.

### MOTIVE

-   To understand the relationship that holds between different parameters which we measure as a part of AQI Data of India.

-   To find out if COVID-19 Nation-wise Lockdowns, Social Distancing and Closure of Industries, Factories and Suspension of movement via private vehicles and public transport had a significant impact on India's AQI.

## UNDERSTANDING THE DATA

Let's take a look at the Data

```{r}
kable(head(air_data_india), caption = "First few rows of the Air Quality Index Data") %>%
  kable_styling(position = "center")
kable(tail(air_data_india), caption = "Last few rows of the Air Quality Index Data") %>%
  kable_styling(position = "center")
```

-   This Dataset contains `r nrow(air_data_india)` rows and `r ncol(air_data_india)` columns.

-   The Year ranges from 2014 to 2021 (till June), with observations recorded on each of the 30 /31 days of the month for 12 months for the last 3 years.

-   The Data is generated from the `r length(unique(air_data_india$City))` cities from various Stations located near that Cities. The Cities include:

```{r City_Stations_List}
kable(station_list, caption = "City Stations") %>%
  kable_styling(position = "center")
```

-   The parameters which we measure at the different Stations are given under the Specie Column and it includes -

```{r Specie_description}
Specie_description <- tibble(
  Parameters = unique(air_data_india$Specie),
  Description = c(
    "Particle pollution/particulate matter(particles less than or equal to 2.5 micrometers in diameter)",
    "Particle pollution/particulate matter(particles less than or equal to 10 micrometers in diameter)",
    "Ground-level ozone",
    "Sulphur dioxide",
    "Nitrogen dioxide",
    "Carbon Monoxide",
    "Temperature",
    "Air Pressure",
    "Wind Gust/Force",
    "Relative Humidity",
    "Wind Speed",
    "Dew Point",
    "Precipitation"
  ),
  Units = c("micrograms/cubic meter","micrograms/cubic meter","micrograms/cubic meter","micrograms/cubic meter","micrograms/cubic meter","miligrams/cubic meter","Celcius","Torr","kmph","No Units","kmph","Celcius","milimeters")
)
kable(Specie_description, caption = "Specie Description") %>%
  kable_styling(position = "center")
```

AQI is a comparable and communicable way of measuring the parameters in the Air. It is calculated when atleast 3 of the top 6 parameter's data is available of which one must be pm10 or pm25. It is the max of the parameters recorded given they satisfy the above condition.

-   It also helps in identifying faulty standards and inadequate monitoring programmes.

-   AQI helps in analysing the change in air quality (improvement or degradation).

-   Comparing air quality conditions at different locations/cities.

-   It can be easily interpreted by anyone, without knowing about background details.

```{r AQI_Info}
AQI_Info <- tibble(
  "AQI Values" = c(
    "0-50",
    "51-100",
    "101-150",
    "151-200",
    "201-300",
    "301-500"
  ),
  "Level of Health Concern" = c(
    "Good",
    "Moderate",
    "Unhealthy for sensitive group",
    "Unhealthy",
    "Very Unhealthy",
    "Hazardous"
  )
)
kable(AQI_Info, caption = "Significance of the AQI Values") %>%
  kable_styling(position = "center")
```

In further Analysis we will refer *pm25, pm10, o3, so2, no2 and co2 as pollutants* and the *remaining weather parameters as non-pollutants*.

## TOP CITY STATIONS

Here we look at *which city records how many observations per year*.

```{r obsv_per_station, fig.asp=0.618, fig.width=12}
obsv_per_station <- air_data_india %>%
  group_by(Year, City) %>%
  count() %>%
  arrange(Year, desc(n)) %>%
  spread(key = Year, value = n) %>%
  arrange(desc(`2019`, `2020`, `2021`))

air_data_india %>%
  group_by(Year, City) %>%
  count() %>%
  filter(Year %in% c("2021", "2020", "2019", "2018")) %>%
  ggplot(aes(City, n, fill = City)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~Year) +
  coord_flip() +
  labs(
    y = "Number of Observations Recorded",
    x = "Cities"
  ) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 3,
      override.aes = list(size = 3)
    )
  ) + ggtitle("Observations Recorded Per Station Every Year") +
  scale_color_viridis(discrete = TRUE)
```

It seems **Delhi is the most monitored cities among the others**. We see all the other stations have almost equal number of observations per year. Our data seems to have lot of missing values for the year 2018 and the years before that; Hence we will only consider the data of the year 2019, 2020 and 2021.

Speculating on the reason *why Delhi is so heavily monitored* we look at *how the Average Median AQI Levels of pollutants at each city every year*.

```{r avg_median_per_year_per_station, fig.asp=0.618, fig.width=12}
avg_median_per_year_per_station <- air_data_india_pollutants %>%
  group_by(Year, City) %>%
  summarise(Median = mean(median)) %>%
  arrange(desc(Year, Median)) %>%
  spread(key = Year, value = Median) %>%
  arrange(desc(`2021`, `2020`, `2019`))

air_data_india_pollutants %>%
  group_by(Year, City) %>%
  summarise(Median = mean(median)) %>%
  arrange(desc(Year, Median)) %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018))) %>%
  ggplot(aes(City, Median, fill = City)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~Year) +
  coord_flip() +
  labs(
    y = "Average Median AQI Levels of Pollutants"
  ) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 3,
      override.aes = list(size = 3)
    )
  ) + ggtitle("Average Median AQI Levels of Pollutants Each City Every Year") +
  scale_color_viridis(discrete = TRUE)
```

Indeed it is clearly visible that **Delhi's AQI Levels of Pollutants is higher** than all other cities. This makes Delhi our city of main focus in all the further analysis. Every city owing to it's location at different parts of the country, different development status, different population, different local weather conditions has different measured values of AQI. So, it makes sense to look at them separately. So, whenever we will look at City-wise Analysis, we will look at these Cities as our **Top 4 Cities** - **Delhi, Muzaffarnagar, Kolkata, Mumbai.**

# VISUAL OVERVIEW

Here we will take a visual tour of the Data through Exploratory Data Analysis.

-   Let's see the AQI Levels in the Top 4 across all 3 measures - Max, Median and Min splitting the year into two halves.

```{r Yearly_Station_Bar_Month_Split, fig.asp=1, fig.width=12}
top_cities <- c("Delhi", "Muzaffarnagar", "Kolkata", "Mumbai")

p1 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018))) %>%
  filter(City %in% top_cities, Month %in% c(1,2,3,4,5,6)) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  group_by(Year, City, Measure) %>%
  summarise(Mean_AQI = mean(AQI)) %>%
  arrange(desc(Year, Mean_AQI)) %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(City, Mean_AQI)) +
  geom_bar(aes(fill = Measure), position = "dodge", stat = "identity") +
  labs(
    y = "Average AQI Levels",
    x = element_blank()
  ) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~Year) + ggtitle("Average AQI Levels Across Our Top 4 Cities - First Half of Year") +
  theme(legend.position = "None") +
  scale_fill_viridis(discrete = TRUE)

p2 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018))) %>%
  filter(City %in% top_cities, !(Month %in% c(1,2,3,4,5,6))) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  group_by(Year, City, Measure) %>%
  summarise(Mean_AQI = mean(AQI)) %>%
  arrange(desc(Year, Mean_AQI)) %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(City, Mean_AQI)) +
  geom_bar(aes(fill = Measure), position = "dodge", stat = "identity") +
  labs(
    y = "Average AQI Levels"
  ) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~Year) + ggtitle("Average AQI Levels Across Our Top 4 Cities - Last Half of Year") +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1,
      override.aes = list(size = 3)
    )
  )  +
  scale_fill_viridis(discrete = TRUE)

ggarrange(p1, p2, nrow = 2)
```

The first bit of observation is the **Median & Min AQI Levels of all 4 cities have dropped in 2020 and 2021 is similar to 2019**. But the **Max AQI Levels have increased in 2020 and even more in 2021** even though we had so many restrictions in 2020!

```{r City_AQI_Box, fig.asp=1, fig.width=12}
p1 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018)), City %in% top_cities, Month %in% c(1,2,3,4,5,6)) %>%
  mutate(Year = as.character(Year)) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  group_by(Year, Month, Day, City, Measure) %>%
  summarise(AQI = mean(AQI, na.rm = TRUE)) %>%
  ggplot(aes(City, AQI, fill =Year, color = Measure)) +
  geom_boxplot(outlier.shape = NA) + 
  #coord_cartesian(ylim = c(0, 200)) +
  labs(y = "Average AQI Levels", fill = "Year") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  )  + ggtitle("Average AQI Levels Across Our Top 4 Cities - First Half of Year") + 
  scale_fill_viridis(discrete = TRUE)

p2 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018)), City %in% top_cities, !(Month %in% c(1,2,3,4,5,6))) %>%
  mutate(Year = as.character(Year)) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  group_by(Year, Month, Day, City, Measure) %>%
  summarise(AQI = mean(AQI, na.rm = TRUE)) %>%
  ggplot(aes(City, AQI, fill =Year, color = Measure)) +
  geom_boxplot(outlier.shape = NA) + 
  #coord_cartesian(ylim = c(0, 250)) +
  labs(y = "Average AQI Levels", fill = "Year") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  )  + ggtitle("Average AQI Levels Across Our Top 4 Cities - Last Half of Year") +
  scale_fill_viridis(discrete = TRUE)

ggarrange(p1, p2, nrow = 2)
```

In the first half of the year 2020 Min and Median AQI Levels have dropped whereas in the second half of the year it either increased or remained same as that of 2019. 2021's observed values are pretty much the same as that of 2019 if not more. Max AQI Levels kept rising across the years irrespective of the part of the years. **The spread(Variance) of the resp. measures look the same across the years**.

-   Let's take a look at the pollutant-wise Levels in our Top 4 Cities.

```{r Specie_Yearly_Viz, fig.asp=1, fig.width=12}
Yearly_Specie <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018))) %>%
  group_by(Year, Specie) %>%
  summarise(Avg_Min = mean(min), Avg_Median = mean(median), Avg_Max = mean(max))

Yearly_Specie_1 <- Yearly_Specie %>%
  gather(Avg_Min, Avg_Median, Avg_Max, key = "Measure", value = "AQI") %>%
  spread(key = Specie, value = AQI)

p1 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018)), Month %in% c(1,2,3,4,5,6), City %in% top_cities) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(Specie, AQI, fill = Year)) +
  geom_boxplot(outlier.shape = NA) +
  coord_cartesian(ylim = c(0,550)) +
  labs(fill = "Year")+
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~City, scales = "free") +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  ) + ggtitle("Average Levels of Pollutants Across Our Top 4 Cities - First Half of Year") +
  scale_fill_viridis(discrete = TRUE)

p2 <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018)), !(Month %in% c(1,2,3,4,5,6)), City %in% top_cities) %>%
  gather(min, median, max, key = "Measure", value = "AQI") %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(Specie, AQI, fill = Year)) +
  geom_boxplot(outlier.shape = NA) +
  coord_cartesian(ylim = c(0,500)) +
  labs(fill = "Year")+
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~City, scales = "free") +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  ) + ggtitle("Average Levels of Pollutants Across Our Top 4 Cities - Last Half of Year") +
  scale_fill_viridis(discrete = TRUE)

ggarrange(p1, p2, nrow = 2)
```

Here we see an interesting effect of Lockdowns. **All the pollutants have decreased considerably in the First half of 2020 whereas in the Second half it has bumped up again to match the Levels of 2019 or even more! While the Levels of 2021 & 2019 are very similar**.

## RELATIONSHIPS - PATTERNS & TRENDS

-   Pollutant Gases and Particulate Matter, whose levels despite being affected by Human Intervention and Industrial Activities, are nothing but Natural Gases which follow nature's process. Here we will take a look at *how the AQI Levels change with seasons throughout the year*.

```{r Station_Monthly_Viz, fig.asp=0.8, fig.width=12}
Monthly_Pollutant_City <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017)) & City %in% avg_median_per_year_per_station$City[1:11]) %>%
  group_by(Year, Month, City) %>%
  summarise(Avg_Min = mean(min), Avg_Median = mean(median), Avg_Max = mean(max))

Monthly_Pollutant_City_1 <- Monthly_Pollutant_City %>%
  gather(Avg_Min, Avg_Median, Avg_Max, key = "Measure", value = "AQI")

air_data_india_All_Specie_Daily_AQI_formulated %>%
  filter(City %in% top_cities) %>%
  group_by(Year, Month, City) %>%
  summarise(AQI = mean(AQI)) %>%
  ggplot(aes(Month, AQI, color = Year)) +
  geom_point(size = 4, alpha = 0.7) +
  stat_smooth(se = FALSE, method = "lm", formula = y ~ x + I(x^2), size = 2) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), axis.line = element_line(colour = "black"),strip.background = element_blank()) +
  facet_wrap(~City) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  ) + 
  facet_wrap(~City) + ggtitle("Monthly AQI Levels") +
  scale_color_viridis(discrete = TRUE)
```

Indeed it looks like the **AQI Levels have dropped in the first half of 2020 compared to 2019, with the exception of Mumbai. But it has increased to levels more than 2019 in the later half. The AQI Levels of 2021 is more that both the previous years**. I have fit here a Quadratic Model which seems to model the situation well though we shouldn't focus on the model fit to 2021 as we only have the data pertaining to first 6 months.

Now, we will see the above observed AQI Levels in terms of Levels of each Pollutants.

```{r Monthly_Pollutant_Viz_and_Daily_Data_wrangling_included, fig.asp=0.8, fig.width=13.5, warning=FALSE, message=FALSE}
Monthly_Specie <- air_data_india_pollutants %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018)), City %in% top_cities) %>%
  group_by(Year, Month, City, Specie) %>%
  summarise(Avg_Min = mean(min), Avg_Median = mean(median), Avg_Max = mean(max))
 

Monthly_Specie_1 <- Monthly_Specie %>%
  gather(Avg_Min, Avg_Median, Avg_Max, key = "Measure", value = "AQI") %>%
  spread(key = Specie, value = AQI)


Monthly_Specie_2 <- Monthly_Specie_1 %>%
  gather(co:so2, key = "Pollutants", value = "AQI") %>%
  mutate(Year = as.character(Year))

air_data_india_All_Specie_Daily <- air_data_india %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018)), City %in% top_cities) %>%
  group_by(Year, Month, Day, City, Specie) %>%
  summarise(Avg_Min = mean(min), Avg_Median = mean(median), Avg_Max = mean(max))

air_data_india_All_Specie_Daily_1 <- air_data_india_All_Specie_Daily %>%
  gather(Avg_Min, Avg_Median, Avg_Max, key = "Measure", value = "AQI")

air_data_india_All_Specie_Daily_2 <- air_data_india_All_Specie_Daily_1 %>%
  spread(key = Specie, value = AQI)

Monthly_Specie_2 %>%
  group_by(Year, Month, City, Pollutants) %>%
  summarise(AQI = mean(AQI)) %>%
  ggplot(aes(Month, AQI, color = Year)) +
  geom_point(alpha = 0.66, size = 3) +
  geom_smooth(se = FALSE, method = "lm", formula = y~x+I(x^2)) +
  labs(
    y = "Average AQI Levels"
  ) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), axis.line = element_line(colour = "black"),panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),strip.background = element_blank()) +
  facet_wrap(~City + Pollutants, ncol = 6, scales = "free", labeller = label_wrap_gen(multi_line=FALSE)) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1,
      override.aes = list(size = 3) 
    )
  ) + ggtitle("Monthly Pollutant Levels") +
  scale_color_viridis(discrete = TRUE, option = "C")
```

**Except for Ground-Level Ozone and Sulphur Dioxide most of the Pollutant Levels have decreased during the first half of 2020 which saw an increase in the second half when compared to 2019.This increase can be attributed to increased Stubble Burning that took place in the later half of the Year**. The surprising thing is that even **particulate matter increased to much higher levels in Mumbai** even though it saw a massive lockdown and transportation as well as industrial work were suspended.

-   The Pollutant Levels are affected to a great deal by the weather conditions of a place. Here we try to look at *how the Pollutant Levels are related to other Pollutant Levels* and *how the weather parameters are related among themselves* followed by a dependency of *Pollutant Levels of weather parameters*.

```{r Monthly_Specie_Scatterplot_Matrix_pol_v_pol, fig.asp=0.7, fig.width=12, message=FALSE, warning=FALSE}
# Exploring the relationships between All Species with each other Monthly
air_data_india_All_Specie_Monthly <- air_data_india %>%
  filter(!(Year %in% c(2014, 2015, 2016, 2017, 2018))) %>%
  filter(City %in% top_cities) %>%
  group_by(Year, Month, City, Specie) %>%
  summarise(Avg_Min = mean(min, na.rm = TRUE), Avg_Median = mean(median, na.rm = TRUE), Avg_Max = mean(max, na.rm = TRUE)) %>%
  mutate(Year = as.character(Year))

air_data_india_All_Specie_Monthly_1 <- air_data_india_All_Specie_Monthly %>%
  gather(Avg_Min, Avg_Median, Avg_Max, key = "Measure", value = "AQI")

air_data_india_All_Specie_Monthly_2 <- air_data_india_All_Specie_Monthly_1 %>%
  spread(key = Specie, value = AQI)

my_fn <- function(data, mapping, ...){
  p <- ggplot(data = data, mapping = mapping) + 
    geom_point() + 
    geom_smooth(method=lm, formula = y~x, fill="red", color="blue", size = 0.5, se = FALSE, ...)
  p
}

# Actually here all the parameters with all the others except Year and Month are really highly correlated. So let's take a look at them 
air_data_india_All_Specie_Monthly_2 %>%
  ggpairs(columns = c("co", "no2", "o3", "so2", "pm10", "pm25"), aes(color = City, shape = Year), progress = FALSE, lower = list(continuous = my_fn)) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) + ggtitle("Scatterplot Matrix for Pollutants") +
  scale_color_viridis(discrete = TRUE)

```

We see a **strong linear relationship between the pollutants** among themselves across the past 3 years at our Top Cities.

```{r Monthly_Specie_Scatterplot_Matrix_nonpol_v_nonpol, fig.asp=0.8, fig.width=12, message=FALSE, warning=FALSE}

air_data_india_All_Specie_Monthly_2 %>%
  ggpairs(columns = c("dew", "humidity", "pressure", "temperature", "wind-speed"), aes(color = City, shape = Year), progress = FALSE) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),strip.background = element_blank()) + ggtitle("Scatterplot Matrix for Weather Parameters") +
  scale_color_viridis(discrete = TRUE)
```

We see a **strong linear relationship between the weather parameters** across the past 3 years. One important thing that gives us a hint towards *why the pm10 and pm25 levels were higher in Mumbai*, as we see **Mumbai has experienced really high wind-speeds in 2020 and 2021. The pm content was thus increased due to movement of lots of dust by wind**.

```{r Monthly_Pol_non_Pol_Scatterplot_Matrix, fig.asp=0.8, fig.width=13, warning=FALSE}
air_data_india_Pollutants_nonpollutants_monthly <- air_data_india_All_Specie_Monthly_1 %>%
  filter(Year != 2018) %>% # There is a lot of Missing values in this year
  spread(key = Specie, value = AQI) %>%
  select(-precipitation, -`wind-gust`) %>%
  gather(dew, humidity, pressure, temperature, `wind-speed`, key = "non_pollutants", value = Levels) %>%
  gather(co, so2, no2, o3, pm10, pm25, key = "pollutants", value = "AQI")

air_data_india_Pollutants_nonpollutants_monthly %>%
  ggplot(aes(AQI, Levels, color = City)) +
  geom_point(alpha = 0.6, aes(shape = Year)) +
  geom_smooth(method = "lm", se = FALSE, formula = y~x, alpha = 0.1, size = 0.5, linetype = "dashed") +
  labs(y = "Weather Parameters Levels", x = "Pollutant Levels") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), axis.line = element_line(colour = "black"),panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),strip.background = element_blank()) +
  facet_wrap(~non_pollutants + pollutants, ncol = 6, scales = "free", labeller = label_wrap_gen(multi_line=FALSE)) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1,
      override.aes = list(size = 5) 
    )
  ) + ggtitle("Pollutants and Weather Parameters Relationship") +
  coord_flip() +
  scale_color_viridis(discrete = TRUE)
```

This suggests that there is a **positive linear relationship between Temperature & Humidity and all the Pollutant Levels**. **Wind speed is indeed positively correlated with pm10 and pm25 which might be the cause for higher AQI in Mumbai**.

-   Another Important thing to keep in mind is *how the weather parameters change with seasons*.

```{r Monthly_nonpol_viz, fig.asp=0.7, fig.width=12}
air_data_india_Pollutants_nonpollutants_monthly %>%
  group_by(Year, Month, non_pollutants) %>%
  summarise(Levels = mean(Levels)) %>%
  ggplot(aes(Month, Levels, color = Year)) +
  geom_point(size = 3) +
  geom_smooth(se = FALSE, method = "lm", formula = y~x + I(x^2) + I(x^3)) +
  facet_wrap(~non_pollutants, scales = "free") +
  labs(y = "Levels")+
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), axis.line = element_line(colour = "black"),panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),strip.background = element_blank()) +
  theme(legend.position = "bottom") +
  guides(
    fill = guide_legend(
      nrow = 1,
      override.aes = list(size = 3)
    )
  ) + ggtitle("Monthly Weather Parameter Levels") +
  scale_color_viridis(discrete = TRUE)
```

It suggests that the **wind-speeds and humidity were higher in 2020, whereas pressure and temperatures were lower in 2020**.

# STATISTICAL INFERENCE

## ESTIMATION

### DISTRIBUTIONS & PROBABILITY MODELS

To perform any kind of analysis we need to model the data we have in order to get an idea about the expected value, variance and other properties related to the data. It also helps us get rid of the noise we get from the data we collect.

-   Here we will look at *how the different pollutants are distributed and how different are the models for different year & location and which probability model fits our data and what are the parameter estimates of the fitted model along with Mean and Variance.*

```{r model_fitting_functions}
fit_distribution <- function(data, title_name = "Model & Data", qqtitle = NULL){
  fit_g <<- invisible(fitdistrplus::fitdist(data, "gamma"))
  fit_l <<- invisible(fitdistrplus::fitdist(data, "lnorm"))
  fit_w <<- invisible(fitdistrplus::fitdist(data, "weibull"))
  fit_n <<- invisible(fitdistrplus::fitdist(data, "norm"))
  fit_e <<- invisible(fitdistrplus::fitdist(data, "exp"))
  
  plot.legend <- c("gamma", "lognormal", "weibull", "normal", "exponential")
  gof <<- fitdistrplus::gofstat(list(fit_g, fit_l, fit_w, fit_n, fit_e), fitnames = plot.legend)
  
  p1 <- fitdistrplus::denscomp(list(fit_g, fit_l, fit_w, fit_n, fit_e), legendtext = plot.legend, fitlwd = c(2,2,2,2,2), xlegend = 0.007, plotstyle = "ggplot") #, fit_e), legendtext = plot.legend, fitlwd = c(3,3.5,4,4.5,1), xlegend = 0.007)
  #fitdistrplus::cdfcomp (list(fit_g, fit_l, fit_w, fit_n, fit_e), legendtext = plot.legend)
  p2 <- fitdistrplus::qqcomp  (list(fit_g, fit_l, fit_w, fit_n, fit_e), legendtext = plot.legend, plotstyle = "ggplot") # , fit_e), legendtext = plot.legend, xlegend = 0.01, )
  #fitdistrplus::ppcomp  (list(fit_g, fit_l, fit_w, fit_n, fit_e), legendtext = plot.legend)
  
  p1 <- p1 +
    theme(legend.justification = c(1, 1), legend.position = c(1, 1)) + ggtitle(title_name) + theme(axis.title.x = element_blank(), axis.title.y = element_blank())
  
  p2 <- p2  +
    theme(legend.position = "None") + ggtitle(qqtitle) + labs(subtitle = paste(rownames(as.data.frame(gof$ks[which.min(gof$ks)])), "seems to fit the data better.")) + theme(axis.title.x = element_blank(), axis.title.y = element_blank())
  
  
  #print(paste(rownames(as.data.frame(gof$ks[which.min(gof$ks)])), "seems to fit the data well"))
  #distfit.table <- tibble("Distribution" = c("Gamma", "Log-Norm", "Weibull", "Norm", "Expo"), "value" = gof$chisqpvalue) %>%
  #  spread(key = Distribution, value = value) %>%
  #  mutate(across(where(is.numeric), ~ round(., digits = 3)))
  #return(distfit.table)
  p <- ggarrange(p1, p2, ncol = 2)
  return(p)
}

proper_fit_distribution <- function(data, heading = "Model & Data"){
  
  invisible(capture.output(p <- fit_distribution(data, heading)))
  
  tf <<- (map_df(list(list(fit_g, fit_l, fit_w, fit_n, fit_e)[as.numeric(which.min(gof$ks))][[1]]$estimate), tidy)) %>%
    spread(key = names, value = x) %>% 
    mutate(across(where(is.numeric), ~ round(., digits = 2)))
  
  if(list(fit_g, fit_l, fit_w, fit_n, fit_e)[as.numeric(which.min(gof$ks))][[1]]$distname == "exp")
    table <- ggtexttable(tibble(Fit = c(colnames(tf)[1], as.character(tf[1]))), theme = ttheme("mCyan"), rows = NULL)
  else
    table <- ggtexttable(tibble(Fit = c(colnames(tf)[1], as.character(tf[1]),colnames(tf)[2], as.character(tf[2])[1])), theme = ttheme("mCyan"), rows = NULL)
  
  if(list(fit_g, fit_l, fit_w, fit_n, fit_e)[as.numeric(which.min(gof$ks))][[1]]$distname == "weibull")
    tablea <-  ggtexttable(tibble(Moments = c("Mean", round(find_mean(dweibull, scale = as.numeric(tf[1]), shape = as.numeric(tf[2]))$value, digits = 2), "Var", round(find_variance(dweibull, scale = as.numeric(tf[1]), shape = as.numeric(tf[2]))$value, digits = 2))), theme = ttheme("mGreen"), rows = NULL)
  if(list(fit_g, fit_l, fit_w, fit_n, fit_e)[as.numeric(which.min(gof$ks))][[1]]$distname == "lnorm")
    tablea <-  ggtexttable(tibble(Moments = c("Mean", round(exp(as.numeric(tf[1]) + 0.5*as.numeric(tf[2])^2), digits = 2), "Var", round(exp(as.numeric(tf[1])*2 + 0.5*4*as.numeric(tf[2])^2) - (exp(as.numeric(tf[1])*1 + 0.5*as.numeric(tf[2])^2))^2, digits = 2))), theme = ttheme("mGreen"), rows = NULL)
  if(list(fit_g, fit_l, fit_w, fit_n, fit_e)[as.numeric(which.min(gof$ks))][[1]]$distname == "gamma")
    tablea <-  ggtexttable(tibble(Moments = c("Mean", round(find_mean(dgamma, rate = as.numeric(tf[1]), shape = as.numeric(tf[2]))$value, digits = 2), "Var", round(find_variance(dgamma, rate = as.numeric(tf[1]), shape = as.numeric(tf[2]))$value, digits = 2))), theme = ttheme("mGreen"), rows = NULL)
  if(list(fit_g, fit_l, fit_w, fit_n, fit_e)[as.numeric(which.min(gof$ks))][[1]]$distname == "norm")
    tablea <-  ggtexttable(tibble(Moments = c("Mean", round(find_mean(dnorm, mean = as.numeric(tf[1]), sd = as.numeric(tf[2]))$value, digits = 2), "Var", round(find_variance(dnorm, mean = as.numeric(tf[1]), sd = as.numeric(tf[2]))$value, digits = 2))), theme = ttheme("mGreen"), rows = NULL)
  if(list(fit_g, fit_l, fit_w, fit_n, fit_e)[as.numeric(which.min(gof$ks))][[1]]$distname == "exp")
    tablea <-  ggtexttable(tibble(Moments = c("Mean", round(1/as.numeric(tf[1]), digits = 2), "Var", round(1/(as.numeric(tf[1]))^2, digits = 2))), theme = ttheme("mGreen"), rows = NULL)
  
  table <- ggarrange(table, tablea, nrow = 2)
  
  p <- ggarrange(p, table, nrow = 1, ncol = 2, widths = c(10,1))
  return(p)
}

fit_distribution_all_cities <- function(data, flag = 1, flag2 = 1, flag3 = 1){
  # So2 Level prediction
  p1 <- proper_fit_distribution((data %>% filter(City == "Kolkata"))$so2, "Kolkata")
  p2 <- proper_fit_distribution((data %>% filter(City == "Delhi"))$so2, "Delhi")
  p3 <- proper_fit_distribution((data %>% filter(City == "Muzaffarnagar"))$so2, "Muzaffarnagar")
  p4 <- proper_fit_distribution((data %>% filter(City == "Mumbai"))$so2, "Mumbai")
  
  fit_so2 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # No2 Level prediction
  p1 <- proper_fit_distribution((data %>% filter(City == "Kolkata"))$no2, "Kolkata")
  p2 <- proper_fit_distribution((data %>% filter(City == "Delhi"))$no2, "Delhi")
  p3 <- proper_fit_distribution((data %>% filter(City == "Muzaffarnagar"))$no2, "Muzaffarnagar")
  p4 <- proper_fit_distribution((data %>% filter(City == "Mumbai"))$no2, "Mumbai")
  
  fit_no2 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # CO Level prediction
  p1 <- proper_fit_distribution((data %>% filter(City == "Kolkata"))$co, "Kolkata")
  p2 <- proper_fit_distribution((data %>% filter(City == "Delhi"))$co, "Delhi")
  p3 <- proper_fit_distribution((data %>% filter(City == "Muzaffarnagar"))$co, "Muzaffarnagar")
  p4 <- proper_fit_distribution((data %>% filter(City == "Mumbai"))$co, "Mumbai")
  
  fit_co <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # O3 Level prediction
  p1 <- proper_fit_distribution((data %>% filter(City == "Kolkata"))$o3, "Kolkata")
  p2 <- proper_fit_distribution((data %>% filter(City == "Delhi"))$o3, "Delhi")
  p3 <- proper_fit_distribution((data %>% filter(City == "Muzaffarnagar"))$o3, "Muzaffarnagar")
  p4 <- proper_fit_distribution((data %>% filter(City == "Mumbai"))$o3, "Mumbai")
  
  fit_o3 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # pm10 Level prediction
  p1 <- proper_fit_distribution((data %>% filter(City == "Kolkata"))$pm10, "Kolkata")
  if(flag2 == 1)
    p2 <- proper_fit_distribution((data %>% filter(City == "Delhi"))$pm10, "Delhi")
  p3 <- proper_fit_distribution((data %>% filter(City == "Muzaffarnagar"))$pm10, "Muzaffarnagar")
  if(flag == 1)
    p4 <- proper_fit_distribution((data %>% filter(City == "Mumbai"))$pm10, "Mumbai")
  
  fit_pm10 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # pm25 Level prediction
  p1 <- proper_fit_distribution((data %>% filter(City == "Kolkata"))$pm25, "Kolkata")
  p2 <- proper_fit_distribution((data %>% filter(City == "Delhi"))$pm25, "Delhi")
  p3 <- proper_fit_distribution((data %>% filter(City == "Muzaffarnagar"))$pm25, "Muzaffarnagar")
  if(flag3 == 1){
    p4 <- proper_fit_distribution((data %>% filter(City == "Mumbai"))$pm25, "Mumbai")
  fit_pm25 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  }else{
    fit_pm25 <- ggarrange(p1,p2,p3, nrow = 2, ncol = 2)}
  
  return(list("fit_so2"=fit_so2, "fit_no2"=fit_no2, "fit_co"=fit_co, "fit_o3"=fit_o3, "fit_pm10"=fit_pm10, "fit_pm25"=fit_pm25))
}
```

```{r expectation_variance_finders}
ev_finder <- function(transform = identity) {
  function(f, ..., from = -Inf, to = Inf) {
    integrate(function(x) transform(x) * f(x, ...), from, to)
  }
}

moment_finder <- function(n, c = 0) {
  ev_finder(function(x) (x - c) ^ n)
}

find_mean <- moment_finder(1)
find_variance <- function(f, ...) {
  mu <- find_mean(f, ...)$value
  moment_finder(2, mu)(f, ...)
}

```

```{r regress_estimation_data_prep, fig.asp=0.7, fig.width=12, cache=TRUE}
air_data_india_All_Specie_Daily_Regress <- air_data_india %>%
  group_by(Year, Month, Day,  Specie, City) %>%
  summarise(Min = mean(min, na.rm = TRUE), Median = mean(median, na.rm = TRUE), Max = mean(max, na.rm = TRUE), Var = mean(variance, na.rm = TRUE))

air_data_india_All_Specie_Daily_Regress <- air_data_india_All_Specie_Daily_Regress %>%
  gather(Min, Median, Max, Var, key = "Measure", value = "AQI")

air_data_india_All_Specie_Daily_Regress <- air_data_india_All_Specie_Daily_Regress %>%
  spread(key = Specie, value = AQI)

air_data_india_All_Specie_Daily_Regress <- air_data_india_All_Specie_Daily_Regress %>%
  filter(City %in% c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai")) %>%
  filter(Year %in% c(2019, 2020, 2021), Measure != "Var") %>%
  group_by(Year, Month, Day, City) %>%
  mutate(Year = as.character(Year)) %>%
  filter(!is.na(so2)) %>%
  filter(!is.na(no2)) %>%
  filter(!is.na(co)) %>%
  filter(!is.na(o3)) %>%
  filter(!is.na(pm25)) %>%
  filter(!(City == "Mumbai" & temperature < 15)) %>%
  filter(!((City == "Mumbai" & co > 50))) %>%
  filter((humidity >= 20 & humidity <= 100) & (dew >= 0 & dew <= 50) & (temperature >= 0 & temperature <= 55) & (pressure >= 600)) %>%
  filter(so2 > 0, no2 > 0, o3 > 0, co > 0, pm10 > 0, pm25 > 0)

```

```{r fit_distribution_all_cities, fig.asp=1.8, fig.width=14, warning=FALSE}
air_data_india_All_Specie_Daily_Regress_model <- air_data_india_All_Specie_Daily_Regress %>%
  filter(Year == 2019, Measure != "Var") %>% # ------------LOOOOOOOK
  filter(Month %in% c(1,2,3,4,5,6))

city_distributions <- fit_distribution_all_cities(air_data_india_All_Specie_Daily_Regress_model)

fig1 <- annotate_figure(city_distributions$fit_pm25, top = text_grob("PM25 Distribution for first 6 Months of 2019", face = "bold", size = 14 ))

air_data_india_All_Specie_Daily_Regress_model <- air_data_india_All_Specie_Daily_Regress %>%
  filter(Year == 2020, Measure != "Var") %>% # ------------LOOOOOOOK
  filter(Month %in% c(1,2,3,4,5,6))

city_distributions <- fit_distribution_all_cities(air_data_india_All_Specie_Daily_Regress_model, flag = 0)

fig2 <- annotate_figure(city_distributions$fit_pm25, top = text_grob("PM25 Distribution for first 6 Months of 2020", face = "bold", size = 14 ))

air_data_india_All_Specie_Daily_Regress_model <- air_data_india_All_Specie_Daily_Regress %>%
  filter(Year == 2021, Measure != "Var") %>% # ------------LOOOOOOOK
  filter(Month %in% c(1,2,3,4,5,6))

city_distributions <- fit_distribution_all_cities(air_data_india_All_Specie_Daily_Regress_model)

fig3 <- annotate_figure(city_distributions$fit_pm25, top = text_grob("PM25 Distribution for first 6 Months of 2021", face = "bold", size = 14 ))

ggarrange(fig1, fig2, fig3, nrow = 3)
```

I have mostly tried **fitting one of Gamma, Lognormal, Normal, Weibull and Exponential Distribution by the Method of Maximum Likelihood Estimation** after looking at the histograms of the data for all the Pollutants. The **better model out of all these 5 models was chosen based on Chi-Squre test for goodness of fit**.

Looking at the moments of the fitted distribution we see one of the most important factor contributing to AQI Calculation i.e. **pm25 Levels during the first 6 months were much lower in all the cities except Mumbai in 2020 compared to 2019, whereas these levels increased back to a much higher value in 2021**.

Similar **Fitted Probability Models suggests almost all the Pollutant Levels were lower in 2020 compared to that of 2019, but the values of 2019 and 2021 are very similar, if not that of 2021 is higher**. I will attach all the relevant Plots and figures for other Pollutants at the end, if interested in looking at them.

There were also some cases were **outliers degraded the fit of the model, I tried minimizing the Hellinger Distance to fit the model in that case**. Below give is one such case -

```{r Hellinger_Fit, fig.asp=0.618, fig.width=12, warning=FALSE, message=FALSE}
# Calculates the sqrt(f).sqrt(g) things that needs to be maximized for minimum hellinger distance
hellinger_distance.minimizer <- function(...) {
  y <<- as.list(...) 
  x <<- as.list(c(NA, unlist(y)))
  x[[1]] <<- c(-Inf, gof$chisqbreaks, Inf)
  hellinger <<- sum(sqrt(diff(do.call(distribution, x)))*sqrt(as.data.frame(gof$chisqtable)[1:(length(gof$chisqbreaks)+1), 3] / sum(as.data.frame(gof$chisqtable)[1:(length(gof$chisqbreaks)+1), 3])))
  return(hellinger)
}

# Fits Model based on Minimizing Hellinger Distance
hellinger_fit <- function(data, distribution){
  data1 <<- data
  distribution <<- distribution
  fit <<- fitdistrplus::fitdist(data, sub('.', '', distribution))
  gof <<- fitdistrplus::gofstat(fit, fitnames = c(sub('.', '', distribution))) 
  estimates <<- optim(par = as.vector(fit$estimate), fn = hellinger_distance.minimizer, control = list(fnscale=-1))
  sq_hellinger_dist <<- sum(diff(do.call(distribution, x))) + sum(as.data.frame(gof$chisqtable)[1:(length(gof$chisqbreaks)+1), 3] / sum(as.data.frame(gof$chisqtable)[1:(length(gof$chisqbreaks)+1), 3])) - 2*hellinger_distance.minimizer(estimates$par)
  return(list("Hellinger_Estimates" = estimates$par, "Square_Hellinger_Distance" = sq_hellinger_dist))
}

# Comparing Hellinger Fit with MLE Fit
compare_hellinger_fit_v_MLE <- function(data, distribution){
  invisible(capture.output(fit_MLE <<- fitdistrplus::fitdist(data, sub('.', '', distribution))))
  invisible(capture.output(fit_hellinger <<- fitdistrplus::fitdist(data, sub('.', '', distribution))))
  invisible(capture.output(fit_hellinger$estimate <<- hellinger_fit(data, distribution)$Hellinger_Estimates))
  
  plot.legend <- c("MLE_Fit", "Hellinger_Fit")
  p1 <- fitdistrplus::denscomp(list(fit_MLE, fit_hellinger), legendtext = plot.legend, fitlwd = c(2, 2), xlegend = 0.007, plotstyle = "ggplot")
  p2 <- fitdistrplus::qqcomp  (list(fit_MLE, fit_hellinger), legendtext = plot.legend, plotstyle = "ggplot")
  p1 <- p1 + theme(legend.justification = c(1, 1), legend.position = c(1, 1)) + ggtitle("Hellinger Fit vs MLE Fit Model")
  p2 <- p2 + theme(legend.position = "None")
  ggarrange(p1, p2, ncol = 2)
}

air_data_india_Pollutants_nonpollutants_daily <- air_data_india_All_Specie_Daily_1 %>%
  filter(Year != 2018) %>% # There is a lot of Missing values in this year
  spread(key = Specie, value = AQI) %>%
  select(-precipitation) %>%
  gather(dew, humidity, pressure, temperature, `wind-gust`, `wind-speed`, key = "non_pollutants", value = Levels) %>%
  gather(co, so2, no2, o3, pm10, pm25, key = "pollutants", value = "AQI")

air_data_pollutants_2021_avg_median <- air_data_india_Pollutants_nonpollutants_daily %>%
  filter(Year == 2021 & Measure == "Avg_Max") %>% # ------------------------------LOOOOOOOOOOOOOOOOOOK!!!!!!!!
  select(-c("non_pollutants", "Levels"))

air_data_pollutants_2021_avg_median_all_pol_summarized_wo_pm <- air_data_pollutants_2021_avg_median %>%
  filter(!(pollutants %in% c("pm10", "pm25"))) %>%
  ungroup() %>%
  group_by(Year, Month, Day) %>%
  summarise(Mean_AQI = mean(AQI, na.rm = TRUE))

annotate_figure(compare_hellinger_fit_v_MLE(air_data_pollutants_2021_avg_median_all_pol_summarized_wo_pm$Mean_AQI, "pweibull"), top = text_grob("Average Median Pollutant Levels(Except pm10 & pm25), 2021", face = "bold", size = 14))
```

It is clear that the **Hellinger fit is much better in fitting the part of the distribution where there are maximum observations**.

## HYPOTHESIS TESTING

Here we would try to Test some of out believes about the data, which will help us get a better understanding of the Pollutant and AQI Levels.

-   In the Introduction part we saw how the number of observations recorded by different cities looked similar except for Delhi which was obviously very high and need not be tested. We would like to *test our null Hypothesis of the number of observations recorded by all cities are equal against all other possible alternatives.* We perform a **Chi-square Equality of proportion Test**

```{r observation_prop_viz_and_chisq_test_for_prop, fig.asp=0.618, fig.width=12}
p1 <- obsv_per_station %>%
  gather(`2021`, `2020`, `2019`, key = "Year", value = Observations) %>%
  select(City, Year, Observations) %>%
  filter(City %in% avg_median_per_year_per_station$City[1:11]) %>%
  ggplot(aes(City, Observations, fill = City)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Year) +
  coord_flip() +
  labs(
    x = "Number of Observations Recorded"
  ) +
  theme(legend.position = "None") +
  scale_color_viridis(discrete = TRUE)

print_chisq_prop <- function(test){
  table <- tibble(
    `Test Statistic` = round(test$statistic, digits = 5),
    df = round(test$parameter, digits = 5),
    `p-value` = round(test$p.value, digits = 5),
  )
  return(list("test_table" = table))
}

test0 <- obsv_per_station %>%
  ungroup() %>%
  filter(City != "Delhi" & City %in% avg_median_per_year_per_station$City[1:11]) %>% # Since it is clearly different
  select(`2019`) %>%
  chisq.test()
test0 <- print_chisq_prop(test0)
table0 <- ggtexttable(test0$test_table, theme = ttheme("mBlue")) %>%
  tab_add_footnote(text = "Chi-sq Test for Equality of Proportion", size = 10, face = "italic")

test1 <- obsv_per_station %>%
  ungroup() %>%
  filter(City != "Delhi" & City %in% avg_median_per_year_per_station$City[1:11]) %>% # Since it is clearly different
  select(`2020`) %>%
  chisq.test()
test1 <- print_chisq_prop(test1)
table1 <- ggtexttable(test1$test_table, theme = ttheme("mBlue")) %>%
  tab_add_footnote(text = "Chi-sq Test for Equality of Proportion", size = 10, face = "italic")

test2 <- obsv_per_station %>%
  ungroup() %>%
  filter(City != "Delhi" & City %in% avg_median_per_year_per_station$City[1:11]) %>% # Since it is clearly different
  select(`2021`) %>%
  chisq.test()
test2 <- print_chisq_prop(test2)
table2 <- ggtexttable(test2$test_table, theme = ttheme("mBlue")) %>%
  tab_add_footnote(text = "Chi-sq Test for Equality of Proportion", size = 10, face = "italic")

p2 <- ggarrange(table0, table1, table2, ncol = 3)
ggarrange(p1, p2, nrow = 2, heights = c(6, 1))
```

Hence, it is clearly visible **all other cities except Delhi are equally monitored in 2019 & 2020, where Delhi is more heavily monitored**.

-   Now the Question that rises is *whether the Mean Level of Pollutants in 2020 Less than that of 2019?* Along with it we will also find out *whether the Mean Level of Pollutants in 2021 More than that of 2020* (Considering the Data of the First 6 months of 2020 and 2021)?

So, to Test our Hypothesis of the Mean Pollutant Level of 2020 is equal to that of 2019 against the Alternative that the Mean Pollutant Level has Dropped in 2020, we will perform a **two sample t-test for equality of mean**. Here after looking at the boxplots, the variances for each year looks more or less the same, and I took variances of both the samples to be same.

```{r average_pollutant_yearly_t_test, fig.asp=0.7, fig.width=12, warning=FALSE, cache=TRUE}
air_data_india_All_Specie_Daily <- air_data_india %>%
  filter(!(Year %in% c(2014, 2015, 2018, 2017))) %>%
  group_by(Year, Month, Day, Specie) %>%
  summarise(Avg_Min = mean(min, na.rm = TRUE), Avg_Median = mean(median, na.rm = TRUE), Avg_Max = mean(max, na.rm = TRUE))

air_data_india_All_Specie_Daily_1 <- air_data_india_All_Specie_Daily %>%
  gather(Avg_Min, Avg_Median, Avg_Max, key = "Measure", value = "AQI")

air_data_india_Pollutants_Daily <- air_data_india_All_Specie_Daily_1 %>%
  group_by(Year, Month, Day) %>%
  filter(Specie %in% c("co", "no2", "o3", "so2", "pm10", "pm25")) %>%
  summarise(Mean_AQI = mean(AQI, na.rm = TRUE))

plt1 <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2019, 2020)) %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(Year, Mean_AQI, fill = Year)) +
  geom_boxplot() +
  stat_summary(fun = "mean") +
  coord_cartesian(ylim = c(20, 100)) +
  labs(y = "Mean AQI", x = NULL) +
  geom_hline(
    yintercept = mean(filter(air_data_india_Pollutants_Daily, Year %in% c(2019, 2020))$Mean_AQI, na.rm = TRUE), size = 1
  )+
  theme(legend.position = "None")

null_distribution1_t <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2019, 2020)) %>%
  mutate(Year = as.character(Year)) %>%
  specify(Mean_AQI ~ Year) %>%
  hypothesise("independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "t", order = c("2020", "2019"))

obs_diff_means1 <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2019, 2020)) %>%
  mutate(Year = as.character(Year)) %>%
  specify(Mean_AQI ~ Year) %>%
  calculate(stat = "t", order = c("2020", "2019"))

sim_test_statistic1 <- visualise(null_distribution1_t, method = "both") +
  shade_p_value(obs_stat = obs_diff_means1, direction = "left")

test1 <- t.test(filter(air_data_india_Pollutants_Daily, Year == 2020)$Mean_AQI, filter(air_data_india_Pollutants_Daily, Year == 2019)$Mean_AQI,
                alternative = "less", var.equal = TRUE, conf.level = 0.99)

table1 <- ggtexttable(map_df(list(test1), tidy), theme = ttheme("mOrange")) %>%
  tab_add_footnote(text = "two-sample t-test for 2019 & 2020", size = 10, face = "italic")

plt2 <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2020, 2021) & Month %in% c(1,2,3,4,5,6)) %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(Year, Mean_AQI, fill = Year)) +
  geom_boxplot() +
  stat_summary(fun = "mean") +
  coord_cartesian(ylim = c(20, 100)) +
  labs(y = "Mean AQI", x = NULL) +
  geom_hline(
    yintercept = mean(filter(air_data_india_Pollutants_Daily, Year %in% c(2020, 2021) & Month %in% c(1,2,3,4,5,6) )$Mean_AQI, na.rm = TRUE), size = 1
  )+
  theme(legend.position = "None")

null_distribution2_t <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2021, 2020) & Month %in% c(1,2,3,4,5,6)) %>%
  mutate(Year = as.character(Year)) %>%
  specify(Mean_AQI ~ Year) %>%
  hypothesise("independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "t", order = c("2021", "2020"))

obs_diff_means2 <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2021, 2020) & Month %in% c(1,2,3,4,5,6)) %>%
  mutate(Year = as.character(Year)) %>%
  specify(Mean_AQI ~ Year) %>%
  calculate(stat = "t", order = c("2021", "2020"))

sim_test_statistic2 <- visualise(null_distribution2_t, method = "both") +
  shade_p_value(obs_stat = obs_diff_means2, direction = "right")

test2 <- t.test(filter(air_data_india_Pollutants_Daily, Year == 2021 & Month %in% c(1,2,3,4,5,6))$Mean_AQI, filter(air_data_india_Pollutants_Daily, Year == 2020 & Month %in% c(1,2,3,4,5,6))$Mean_AQI,
                alternative = "greater", var.equal = TRUE, conf.level = 0.99)

table2 <- ggtexttable(map_df(list(test2), tidy), theme = ttheme("mOrange")) %>%
  tab_add_footnote(text = "two-sample t-test for 2021 & 2021", size = 10, face = "italic")

p1 <- ggarrange(plt1, plt2, ncol = 2)
p2 <- ggarrange(sim_test_statistic1, sim_test_statistic2, ncol = 2)
p3 <- ggarrange(table1, table2, nrow = 2) 
ggarrange(p1, p2, p3, nrow = 3, heights = c(3, 3, 2))
```

So, **it is true that 2021's Pollutant Levels are more than that of 2020 to be precise it is atleast 7.5 points higher with 99% Confidence** when comparing the first 6 months. But it is surprising that **2020's Pollutant Levels haven't dropped significantly compared to 2019** despite Lockdowns and all other measures which were favorable for decrease of Air Pollutant Levels.

Now, we try to look at the first half and later half of the Years separately, cause the Nation-wide Lockdown was there during the First Half of 2020. We test the same hypothesis as above, but now on split data.

```{r average_pollutant_first6month_t_test, fig.asp=0.7, fig.width=12, warning=FALSE, cache=TRUE}
plt3 <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2019, 2020, 2021) & Month %in% c(1,2,3,4,5,6)) %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(Year, Mean_AQI, fill = Year)) +
  geom_boxplot() +
  stat_summary(fun = "mean") +
  coord_cartesian(ylim = c(20, 100)) +
  labs(x = NULL) +
  theme(legend.position = "None") 

null_distribution1_t <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2019, 2020) & Month %in% c(1,2,3,4,5,6)) %>%
  mutate(Year = as.character(Year)) %>%
  specify(Mean_AQI ~ Year) %>%
  hypothesise("independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "t", order = c("2020", "2019"))

obs_diff_means1 <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2019, 2020) & Month %in% c(1,2,3,4,5,6)) %>%
  mutate(Year = as.character(Year)) %>%
  specify(Mean_AQI ~ Year) %>%
  calculate(stat = "t", order = c("2020", "2019"))

sim_test_statistic1 <- visualise(null_distribution1_t, method = "both") +
  shade_p_value(obs_stat = obs_diff_means1, direction = "left")

test1 <- t.test(filter(air_data_india_Pollutants_Daily, Year == 2020 & Month %in% c(1,2,3,4,5,6))$Mean_AQI, filter(air_data_india_Pollutants_Daily, Year == 2019 & Month %in% c(1,2,3,4,5,6))$Mean_AQI,
                alternative = "less", var.equal = TRUE, conf.level = 0.99)

table1 <- ggtexttable(map_df(list(test1), tidy), theme = ttheme("mOrange")) %>%
  tab_add_footnote(text = "two-sample t-test for 2019 & 2020", size = 10, face = "italic")

null_distribution2_t <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2021, 2019) & Month %in% c(1,2,3,4,5,6)) %>%
  mutate(Year = as.character(Year)) %>%
  specify(Mean_AQI ~ Year) %>%
  hypothesise("independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "t", order = c("2021", "2019"))

obs_diff_means2 <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2021, 2019) & Month %in% c(1,2,3,4,5,6)) %>%
  mutate(Year = as.character(Year)) %>%
  specify(Mean_AQI ~ Year) %>%
  calculate(stat = "t", order = c("2021", "2019"))

sim_test_statistic2 <- visualise(null_distribution2_t, method = "both") +
  shade_p_value(obs_stat = obs_diff_means2, direction = "both")

test2 <- t.test(filter(air_data_india_Pollutants_Daily, Year == 2021 & Month %in% c(1,2,3,4,5,6))$Mean_AQI, filter(air_data_india_Pollutants_Daily, Year == 2019 & Month %in% c(1,2,3,4,5,6))$Mean_AQI,
                alternative = "two.sided", var.equal = TRUE, conf.level = 0.99)

table2 <- ggtexttable(map_df(list(test2), tidy), theme = ttheme("mOrange")) %>%
  tab_add_footnote(text = "two-sample t-test for 2021 & 2019", size = 10, face = "italic")

p1 <- ggarrange(plt3, ncol = 1)
p2 <- ggarrange(sim_test_statistic1, sim_test_statistic2, ncol = 2)
p3 <- ggarrange(table1, table2, nrow = 2) 
ggarrange(p1, p2, p3, nrow = 3, heights = c(4, 3, 2))
```

Indeed our guess was right here. The **Pollutant Levels have decreased during the first half of 2020 by atleast 6.4 points with 99% confidence and we reject our Null Hypothesis**.

An Interesting look at the second half of 2020 and performing an *Hypothesis testing for the Mean Level of Pollutants for 2019 and 2020 are equal against that of 2020 was higher* reveals that **2020's Level was higher in the second half**.

```{r average_pollutant_last6month_t_test, fig.asp=0.7, fig.width=12, warning=FALSE, cache=TRUE}
plt5 <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2019, 2020) & Month %in% c(7,8,9,10, 11, 12)) %>%
  mutate(Year = as.character(Year)) %>%
  ggplot(aes(Year, Mean_AQI, fill = Year)) +
  geom_boxplot() +
  stat_summary(fun = "mean") +
  coord_cartesian(ylim = c(20, 100)) +
  geom_hline(
    yintercept = mean(filter(air_data_india_Pollutants_Daily, Year %in% c(2019, 2020) & Month %in% c(7,8,9,10, 11, 12))$Mean_AQI, na.rm = TRUE), size = 1
  )+
  labs(x = NULL, y = "Mean AQI") +
  theme(legend.position = "None") 

null_distribution1_t <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2019, 2020) & Month %in% c(7,8,9,10, 11, 12)) %>%
  mutate(Year = as.character(Year)) %>%
  specify(Mean_AQI ~ Year) %>%
  hypothesise("independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "t", order = c("2020", "2019"))

obs_diff_means1 <- air_data_india_Pollutants_Daily %>%
  filter(Year %in% c(2019, 2020) & Month %in% c(7,8,9,10, 11, 12)) %>%
  mutate(Year = as.character(Year)) %>%
  specify(Mean_AQI ~ Year) %>%
  calculate(stat = "t", order = c("2020", "2019"))

sim_test_statistic1 <- visualise(null_distribution1_t, method = "both") +
  shade_p_value(obs_stat = obs_diff_means1, direction = "right")

test1 <- t.test(filter(air_data_india_Pollutants_Daily, Year == 2020 & Month %in% c(7,8,9,10, 11, 12))$Mean_AQI, filter(air_data_india_Pollutants_Daily, Year == 2019 & Month %in% c(7,8,9,10, 11, 12))$Mean_AQI,
                alternative = "greater", var.equal = TRUE, conf.level = 0.99)

table1 <- ggtexttable(map_df(list(test1), tidy), theme = ttheme("mOrange")) %>%
  tab_add_footnote(text = "two-sample t-test for 2019 & 2020", size = 10, face = "italic")

p1 <- ggarrange(plt5, sim_test_statistic1, ncol = 2)
p3 <- ggarrange(table1, nrow = 1) 
ggarrange(p1, p3, nrow = 2, heights = c(6, 1))
```

-   Now we turn to finding out *how different are the Mean AQI Levels of Each Pollutants*.

Considering the First Half of 2019, 2020 and 2021:

Here we will perform **two-sample t-tests** and will find **99% confidence interval for difference of two mean assuming same variance**. Our Tests are to be performed with *Null Hypothesis being 2020 and 2019 Mean Level of Pollutants are same against the alternative that the Mean Pollutant Level of 2020 being less than 2019*. Similarly we will perform a test for *2021's Mean Level being higher than 2020's*. And we will test *whether Mean of 2021 and 2019 are equal, which will be a both-sided test*.

The first row of each table corresponds to the first test, second row to second test and third row to third test from the tests mentioned above.

```{r average_indiv_pollutant_first6month_t_test, fig.asp=0.8, fig.width=12, warning=FALSE}
air_data_india_first6month_pollutants_daily <- air_data_india_All_Specie_Daily_1 %>%
  group_by(Year, Month, Day, Specie) %>%
  filter(Year != 2018) %>%
  mutate(Year = as.character(Year)) %>%
  filter(Specie %in% c("co", "no2", "o3", "so2", "pm10", "pm25")) %>%
  filter(Month %in% c(1,2,3,4,5,6)) %>%
  summarise(Mean_AQI = mean(AQI, na.rm = TRUE))

label <- tibble(label = "Row-1: t-test 2020 & 2019\nRow-2: t-test 2021 & 2020\nRow-1: t-test 2019 & 2021")

plt2 <- air_data_india_first6month_pollutants_daily %>%
  filter(Specie %in% c("co", "no2", "o3")) %>%
  ggplot(aes(Year, Mean_AQI, fill = Specie)) +
  geom_boxplot(outlier.shape = NA) +
  stat_summary(fun = "mean") +
  labs(y = NULL, x = NULL) +
  facet_wrap(~Specie, scales = "free") +
  scale_fill_brewer(palette = "Dark2") +
  theme(strip.background = element_blank(),
        strip.text.x = element_blank(), legend.position = c(0.5, 0.025), 
      legend.key = element_rect(fill = "transparent", colour = "transparent")) +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  )

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "co")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "co")$Mean_AQI,
                alternative = "less", var.equal = TRUE, conf.level = 0.99)

test_2 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "co")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "co")$Mean_AQI,
                   alternative = "greater", var.equal = TRUE, conf.level = 0.99)

test_3 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "co")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "co")$Mean_AQI,
                   alternative = "two.sided", var.equal = TRUE, conf.level = 0.99)

table.fit <- full_join(full_join(select(map_df(list(test_1), tidy), -c(parameter, method, statistic)), select(map_df(list(test_2), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative")), select(map_df(list(test_3), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative"))

table.fit <- table.fit %>%
  select(-c(estimate1, estimate2)) %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3)))

table1 <- ggtexttable(table.fit, theme = ttheme("mGreen"), rows = NULL)

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "no2")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "no2")$Mean_AQI,
                 alternative = "less", var.equal = TRUE, conf.level = 0.99)

test_2 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "no2")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "no2")$Mean_AQI,
                 alternative = "greater", var.equal = TRUE, conf.level = 0.99)

test_3 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "no2")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "no2")$Mean_AQI,
                 alternative = "two.sided", var.equal = TRUE, conf.level = 0.99)

table.fit <- full_join(full_join(select(map_df(list(test_1), tidy), -c(parameter, method, statistic)), select(map_df(list(test_2), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative")), select(map_df(list(test_3), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative"))

table.fit <- table.fit %>%
  select(-c(estimate1, estimate2)) %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3)))

table2 <- ggtexttable(table.fit, theme = ttheme("mGreen"), rows = NULL)

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "o3")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "o3")$Mean_AQI,
                 alternative = "less", var.equal = TRUE, conf.level = 0.99)

test_2 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "o3")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "o3")$Mean_AQI,
                 alternative = "greater", var.equal = TRUE, conf.level = 0.99)

test_3 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "o3")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "o3")$Mean_AQI,
                 alternative = "two.sided", var.equal = TRUE, conf.level = 0.99)

table.fit <- full_join(full_join(select(map_df(list(test_1), tidy), -c(parameter, method, statistic)), select(map_df(list(test_2), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative")), select(map_df(list(test_3), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative"))

table.fit <- table.fit %>%
  select(-c(estimate1, estimate2)) %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3)))

table3 <- ggtexttable(table.fit, theme = ttheme("mGreen"), rows = NULL)

table <- ggarrange(table1, table2, table3, ncol = 3)
p1 <- ggarrange(plt2, table, nrow = 2, heights = c(6, 3))

plt3 <- air_data_india_first6month_pollutants_daily %>%
  filter(Specie %in% c("so2", "pm10", "pm25")) %>%
  ggplot(aes(Year, Mean_AQI, fill = Specie)) +
  geom_boxplot(outlier.shape = NA) +
  stat_summary(fun = "mean") +
  labs(y = NULL, x = NULL) +
  facet_wrap(~Specie, scales = "free") +
  scale_fill_brewer(palette = "RdBu") +
  theme(strip.background = element_blank(),
        strip.text.x = element_blank(), legend.position = c(0.5, 0.025),
      legend.key = element_rect(fill = "transparent", colour = "transparent")) +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  )

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "pm10")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "pm10")$Mean_AQI,
                 alternative = "less", var.equal = TRUE, conf.level = 0.99)

test_2 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "pm10")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "pm10")$Mean_AQI,
                 alternative = "greater", var.equal = TRUE, conf.level = 0.99)

test_3 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "pm10")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "pm10")$Mean_AQI,
                 alternative = "two.sided", var.equal = TRUE, conf.level = 0.99)

table.fit <- full_join(full_join(select(map_df(list(test_1), tidy), -c(parameter, method, statistic)), select(map_df(list(test_2), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative")), select(map_df(list(test_3), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative"))

table.fit <- table.fit %>%
  select(-c(estimate1, estimate2)) %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3)))

table1 <- ggtexttable(table.fit, theme = ttheme("mGreen"), rows = NULL)

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "pm25")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "pm25")$Mean_AQI,
                 alternative = "less", var.equal = TRUE, conf.level = 0.99)

test_2 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "pm25")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "pm25")$Mean_AQI,
                 alternative = "greater", var.equal = TRUE, conf.level = 0.99)

test_3 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "pm25")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "pm25")$Mean_AQI,
                 alternative = "two.sided", var.equal = TRUE, conf.level = 0.99)

table.fit <- full_join(full_join(select(map_df(list(test_1), tidy), -c(parameter, method, statistic)), select(map_df(list(test_2), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative")), select(map_df(list(test_3), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative"))

table.fit <- table.fit %>%
  select(-c(estimate1, estimate2)) %>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3)))

table2 <- ggtexttable(table.fit, theme = ttheme("mGreen"), rows = NULL)

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "so2")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "so2")$Mean_AQI,
                 alternative = "less", var.equal = TRUE, conf.level = 0.99)

test_2 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "so2")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "so2")$Mean_AQI,
                 alternative = "greater", var.equal = TRUE, conf.level = 0.99)

test_3 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2021 & Specie == "so2")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "so2")$Mean_AQI,
                 alternative = "two.sided", var.equal = TRUE, conf.level = 0.99)

table.fit <- full_join(full_join(select(map_df(list(test_1), tidy), -c(parameter, method, statistic)), select(map_df(list(test_2), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative")), select(map_df(list(test_3), tidy), -c(parameter, method, statistic)), by = c("estimate", "estimate1", "estimate2", "p.value", "conf.low", "conf.high", "alternative"))

table.fit <- table.fit %>%
  select(-c(estimate1, estimate2) )%>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3)))

table3 <- ggtexttable(table.fit, theme = ttheme("mGreen"), rows = NULL)

table <- ggarrange(table1, table2, table3, ncol = 3)
p2 <- ggarrange(plt3, table, nrow = 2, heights = c(6, 3))

ggarrange(p1, p2, nrow = 2)
```

Indeed! In case of most of the Pollutants our guess seem to hold! And **2020's Pollutant Levels dropped when compared to 2019 and 2021, whereas the means of 2021 and 2019 are similar**.

A similar Test Considering the second half of 2020 and 2019, where we *test the null against the alternative of 2020's Mean Level of Pollutant being higher than that of 2019*, reveals -

```{r average_indiv_pollutant_lastt6month_t_test, fig.asp=0.7, fig.width=12, warning=FALSE}
air_data_india_first6month_pollutants_daily <- air_data_india_All_Specie_Daily_1 %>%
  group_by(Year, Month, Day, Specie) %>%
  filter(Year != 2018, Year != 2016 ) %>%
  mutate(Year = as.character(Year)) %>%
  filter(Specie %in% c("co", "no2", "o3", "so2", "pm10", "pm25")) %>%
  filter(Month %in% c(7, 8, 9, 10, 11, 12)) %>%
  summarise(Mean_AQI = mean(AQI, na.rm = TRUE))

label <- tibble(label = "Row-1: t-test 2020 & 2019\nRow-2: t-test 2021 & 2020\nRow-1: t-test 2019 & 2021")

plt2 <- air_data_india_first6month_pollutants_daily %>%
  filter(Specie %in% c("co", "no2", "o3")) %>%
  ggplot(aes(Year, Mean_AQI, fill = Specie)) +
  geom_boxplot(outlier.shape = NA) +
  stat_summary(fun = "mean") +
  labs(y = NULL, x = NULL) +
  facet_wrap(~Specie, scales = "free") +
  scale_fill_brewer(palette = "Dark2") +
  theme(strip.background = element_blank(),
        strip.text.x = element_blank(), legend.position = c(0.5, 0.025), 
      legend.key = element_rect(fill = "transparent", colour = "transparent")) +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  )

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "co")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "co")$Mean_AQI,
                alternative = "greater", var.equal = TRUE, conf.level = 0.99)

table1 <- ggtexttable(select(map_df(list(test_1), tidy), -c(parameter, method, statistic, estimate1, estimate2))%>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))), theme = ttheme("mGreen"), rows = NULL)

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "no2")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "no2")$Mean_AQI,
                 alternative = "greater", var.equal = TRUE, conf.level = 0.99)

table2 <- ggtexttable(select(map_df(list(test_1), tidy), -c(parameter, method, statistic, estimate1, estimate2))%>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))), theme = ttheme("mGreen"), rows = NULL)

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "o3")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "o3")$Mean_AQI,
                 alternative = "greater", var.equal = TRUE, conf.level = 0.99)

table3 <- ggtexttable(select(map_df(list(test_1), tidy), -c(parameter, method, statistic, estimate1, estimate2))%>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))), theme = ttheme("mGreen"), rows = NULL)

table <- ggarrange(table1, table2, table3, ncol = 3)
p1 <- ggarrange(plt2, table, nrow = 2, heights = c(6, 3))

plt3 <- air_data_india_first6month_pollutants_daily %>%
  filter(Specie %in% c("so2", "pm10", "pm25")) %>%
  ggplot(aes(Year, Mean_AQI, fill = Specie)) +
  geom_boxplot(outlier.shape = NA) +
  stat_summary(fun = "mean") +
  labs(y = NULL, x = NULL) +
  facet_wrap(~Specie, scales = "free") +
  scale_fill_brewer(palette = "RdBu") +
  theme(strip.background = element_blank(),
        strip.text.x = element_blank(), legend.position = c(0.5, 0.025),
      legend.key = element_rect(fill = "transparent", colour = "transparent")) +
  guides(
    fill = guide_legend(
      nrow = 1
    )
  )

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "pm10")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "pm10")$Mean_AQI,
                 alternative = "greater", var.equal = TRUE, conf.level = 0.99)

table1 <- ggtexttable(select(map_df(list(test_1), tidy), -c(parameter, method, statistic, estimate1, estimate2))%>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))), theme = ttheme("mGreen"), rows = NULL)

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "pm25")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "pm25")$Mean_AQI,
                 alternative = "greater", var.equal = TRUE, conf.level = 0.99)

table2 <- ggtexttable(select(map_df(list(test_1), tidy), -c(parameter, method, statistic, estimate1, estimate2))%>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))), theme = ttheme("mGreen"), rows = NULL)

test_1 <- t.test(filter(air_data_india_first6month_pollutants_daily, Year == 2020 & Specie == "so2")$Mean_AQI, filter(air_data_india_first6month_pollutants_daily, Year == 2019 & Specie == "so2")$Mean_AQI,
                 alternative = "greater", var.equal = TRUE, conf.level = 0.99)

table3 <- ggtexttable(select(map_df(list(test_1), tidy), -c(parameter, method, statistic, estimate1, estimate2))%>% 
  mutate(across(where(is.numeric), ~ round(., digits = 3))), theme = ttheme("mGreen"), rows = NULL)

table <- ggarrange(table1, table2, table3, ncol = 3)
p2 <- ggarrange(plt3, table, nrow = 2, heights = c(6, 3))

ggarrange(p1, p2, nrow = 2)
```

That **almost all the Pollutant's Levels have either gone up or remained same as that of 2019's**. A possible cause for this to happen **maybe due to a 40% increase in Stubble Burning during the later half of 2020 as per what various reports suggests**.

# MODELING

In this section we will try to analyze the data and will provide a quantitative way to summarize the trends and patterns. We will mostly be using concepts and techniques pertaining to **Multiple Linear Regression(MLR)**.

## REGRESSION

Here we will try to fit a MLR to the strong linear relationship we saw in the Visual Overview Section. Because of the difficulty in visualization, residuals will play an important role in deciding model fit.

-   We will look at *what is the linear relationship between each Pollutant Level and weather parameters*, *what is the linear relationship between each Pollutant with other Pollutant* We will also look at the *standard error of our the estimates and their confidence intervals* and *how much the weather parameters explains the variation in the pollutant levels.*

-   Some assumptions made during Modelling are-

    -   The weather parameters are independent of the Level of pollutants.

    -   The weather parameters are similarly distributed across 2019, 2020 and 2021 [Except for Mumbai where we see an increased wind-speed in the later two years]

In most of the models which we will try to fit we will look at the first half and the second half of the year separately.

```{r Helper_Functions_Regression}
# Making Predictions and checking distribution of residuals
make_predictions <- function(trained_model, test_data){
  predictions <- test_data %>%
    add_predictions(trained_model) %>%
    add_residuals(trained_model)
  p <- predictions %>%
    ggplot(aes(resid, ..density..)) +
    geom_histogram()
  return(p)
}

# Training top 9 cities
train_all_cities_pol_with_nonpol <- function(data){
  # so2 on non-pollutants
  model_s1 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_s2 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_s3 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_s4 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # no2 on non-pollutants
  model_n1 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_n2 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_n3 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_n4 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # co on non-pollutants
  model_c1 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_c2 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_c3 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_c4 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # o3 on non-pollutants
  model_o1 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_o2 <<- lm(o3~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_o3 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_o4 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # pm10 on non-pollutants
  model_p1 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p2 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p3 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p4 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # pm25 on non-pollutants
  model_p.1 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p.2 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p.3 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p.4 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
}

train_all_cities_pol_with_otherpol <- function(data){
  # so2 on pollutants
  model_s1 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_s2 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_s3 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_s4 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  
  # no2 on pollutants
  model_n1 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_n2 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_n3 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_n4 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  
  
  # co on pollutants
  model_c1 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_c2 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_c3 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_c4 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  
  
  # o3 on pollutants
  model_o1 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_o2 <<- lm(o3~ so2 + no2 + co + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_o3 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_o4 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  
  # pm10 on pollutants
  model_p1 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Kolkata"))
  model_p2 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Delhi"))
  model_p3 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_p4 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Mumbai"))

  # pm25 on non-pollutants
  model_p.1 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data %>% filter(City == "Kolkata"))
  model_p.2 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data %>% filter(City == "Delhi"))
  model_p.3 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data %>% filter(City == "Muzaffarnagar"))
  model_p.4 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data %>% filter(City == "Mumbai"))
  
}

full_train_all_cities_pol <- function(data){
  # so2 on non-pollutants
  model_s1 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_s2 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_s3 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_s4 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # no2 on non-pollutants
  model_n1 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_n2 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_n3 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_n4 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # co on non-pollutants
  model_c1 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_c2 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_c3 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_c4 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # o3 on non-pollutants
  model_o1 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_o2 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_o3 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_o4 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))

  # pm10 on non-pollutants
  model_p1 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p2 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p3 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p4 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # pm25 on non-pollutants
  model_p.1 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p.2 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p.3 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p.4 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))

}

# Training top 9 cities
train_all_cities_pol_with_nonpol_wl <- function(data){
  # so2 on non-pollutants
  model_s1 <<- lm(log(so2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_s2 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_s3 <<- lm(log(so2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_s4 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  model_s5 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  model_s6 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_s7 <<- lm(log(so2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_s8 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_s9 <<- lm(log(so2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_s1)
  summary(model_s2)
  summary(model_s3)
  summary(model_s4)
  summary(model_s5)
  summary(model_s6)
  summary(model_s7)
  summary(model_s8)
  summary(model_s9)
  
  # no2 on non-pollutants
  model_n1 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_n2 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_n3 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_n4 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  model_n5 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  model_n6 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_n7 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_n8 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_n9 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_n1)
  summary(model_n2)
  summary(model_n3)
  summary(model_n4)
  summary(model_n5)
  summary(model_n6)
  summary(model_n7)
  summary(model_n8)
  summary(model_n9)
  
  # co on non-pollutants
  model_c1 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_c2 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_c3 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_c4 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  model_c5 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  model_c6 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_c7 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_c8 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_c9 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_c1)
  summary(model_c2)
  summary(model_c3)
  summary(model_c4)
  summary(model_c5)
  summary(model_c6)
  summary(model_c7)
  summary(model_c8)
  summary(model_c9)
  
  # o3 on non-pollutants
  model_o1 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_o2 <<- lm(log(o3)~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_o3 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_o4 <<- lm(log(o3) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  model_o5 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  model_o6 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_o7 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_o8 <<- lm(log(o3) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_o9 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_o1)
  summary(model_o2)
  summary(model_o3)
  summary(model_o4)
  summary(model_o5)
  summary(model_o6)
  summary(model_o7)
  summary(model_o8)
  summary(model_o9)
  
  # pm10 on non-pollutants
  model_p1 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p2 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p3 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p4 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  #model_p5 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  #model_p6 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_p7 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_p8 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_p9 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_p1)
  summary(model_p2)
  summary(model_p3)
  summary(model_p4)
  #summary(model_p5)
  #summary(model_p6)
  summary(model_p7)
  summary(model_p8)
  summary(model_p9)
  
  # pm25 on non-pollutants
  model_p.1 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p.2 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p.3 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p.4 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  model_p.5 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  model_p.6 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_p.7 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_p.8 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_p.9 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_p.1)
  summary(model_p.2)
  summary(model_p.3)
  summary(model_p.4)
  summary(model_p.5)
  summary(model_p.6)
  summary(model_p.7)
  summary(model_p.8)
  invisible(summary(model_p.9))
}



# Print all City Model Summaries
print_all_city_model_summary <- function(){
  model_so2 <- export_summs(model_s1, model_s2, model_s3, model_s4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))
  model_no2 <- export_summs(model_n1, model_n2, model_n3, model_n4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))
  model_co <- export_summs(model_c1, model_c2, model_c3, model_c4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))
  model_o3 <- export_summs(model_o1, model_o2, model_o3, model_o4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))
  model_pm10 <- export_summs(model_p1, model_p2, model_p3, model_p4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))
  model_pm25 <- export_summs(model_p.1, model_p.2, model_p.3, model_p.4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))
  return(list("model_so2"=model_so2, "model_no2"=model_no2, "model_co"=model_co, "model_o3"=model_o3, "model_pm10"=model_pm10, "model_pm25"=model_pm25))
}

# Predicting top 9 cities pollutants from non pol trained data
predict_all_cities_pol <- function(data){
  # Non-pollutants based predictions --- MAKE SURE THE model_s1 and all model used in this part is trained with non-pollutants
  
  # So2 Level prediction
  p1 <- make_predictions(model_s1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_s2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_s3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_s4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_so2 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # No2 Level prediction
  p1 <- make_predictions(model_n1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_n2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_n3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_n4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_no2 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # CO Level prediction
  p1 <- make_predictions(model_c1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_c2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_c3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_c4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_co <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # O3 Level prediction
  p1 <- make_predictions(model_o1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_o2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_o3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_o4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_o3 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # pm10 Level prediction
  p1 <- make_predictions(model_p1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_p2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_p3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_p4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_pm10 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # pm25 Level prediction
  p1 <- make_predictions(model_p.1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_p.2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_p.3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_p.4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_pm25 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  return(list("res_so2"=res_so2, "res_no2"=res_no2, "res_co"=res_co, "res_o3"=res_o3, "res_pm10"=res_pm10, "res_pm25"=res_pm25))
}

# Test Data R^2
find_R.squared <- function(model, data){
  predictions <- data %>%
    add_predictions(model)
  predictions <- predictions %>%
    filter(!is.na(pred))
  y <- as.data.frame(predictions[,model$terms[[2]]])[,1]
  R.squared <- cor(predictions$pred, y)^2
  return(R.squared)
}

# Test Data R^2 Print
print_all_cities_R.squared <- function(data){
  R2.so2 <- tibble(
    "Kolkata" = find_R.squared(model_s1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_s2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_s3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_s4, data %>% filter(City == "Mumbai")),
  )
  R2.no2 <- tibble(
    "Kolkata" = find_R.squared(model_n1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_n2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_n3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_n4, data %>% filter(City == "Mumbai")),
  )
  R2.co <- tibble(
    "Kolkata" = find_R.squared(model_c1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_c2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_c3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_c4, data %>% filter(City == "Mumbai")),
  )
  R2.o3 <- tibble(
    "Kolkata" = find_R.squared(model_o1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_o2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_o3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_o4, data %>% filter(City == "Mumbai")),
  )
  R2.pm10 <- tibble(
    "Kolkata" = find_R.squared(model_p1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_p2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_p3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_p4, data %>% filter(City == "Mumbai")),
  )
  R2.pm25 <- tibble(
    "Kolkata" = find_R.squared(model_p.1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_p.2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_p.3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_p.4, data %>% filter(City == "Mumbai")),
  )
  
  Prediction_Table <- full_join(full_join(full_join(full_join(full_join(R2.so2, R2.no2), R2.co), R2.o3), R2.pm10), R2.pm25)
  Prediction_Table <- Prediction_Table %>%
    mutate(Pollutant = c("so2", "no2", "co", "o3", "pm10", "pm25")) %>%
    select(Pollutant, everything())
  return(list("R2.so2" = R2.so2, "R2.no2" = R2.no2, "R2.co" = R2.co, "R2.o3" = R2.o3, "R2.pm10" = R2.pm10, "R2.pm25" = R2.pm25, "Prediction_Table" = Prediction_Table))
}

# Added Variable Plot
added_variable_plot <- function(data, model_1, model_2){
  residuals <- data %>%
    add_residuals(model_1, var = "resid_1") %>%
    add_residuals(model_2, var = "resid_2")
  
  p1 <- residuals %>%
    ggplot(aes(resid_1, resid_2)) +
    geom_point() +
    labs(
      x = paste(model_1$terms[[2]], "resid"),
      y = paste(model_2$terms[[2]], "resid")
    )
  print(p1)
}

# Added Variable Plots All Cities
added_variable_plot_all_cities <- function(data){
  p1 <- added_variable_plot(data, model_s1, model_n1)
  p2 <- added_variable_plot(data, model_s1, model_c1)
  p3 <- added_variable_plot(data, model_s1, model_o1)
  p4 <- added_variable_plot(data, model_s1, model_p1)
  p5 <- added_variable_plot(data, model_s1, model_p.1)
  r1 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_n1, model_s1)
  p2 <- added_variable_plot(data, model_n1, model_c1)
  p3 <- added_variable_plot(data, model_n1, model_o1)
  p4 <- added_variable_plot(data, model_n1, model_p1)
  p5 <- added_variable_plot(data, model_n1, model_p.1)
  r2 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_c1, model_s1)
  p2 <- added_variable_plot(data, model_c1, model_n1)
  p3 <- added_variable_plot(data, model_c1, model_o1)
  p4 <- added_variable_plot(data, model_c1, model_p1)
  p5 <- added_variable_plot(data, model_c1, model_p.1)
  r3 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_o1, model_s1)
  p2 <- added_variable_plot(data, model_o1, model_c1)
  p3 <- added_variable_plot(data, model_o1, model_n1)
  p4 <- added_variable_plot(data, model_o1, model_p1)
  p5 <- added_variable_plot(data, model_o1, model_p.1)
  r4 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p1, model_s1)
  p2 <- added_variable_plot(data, model_p1, model_c1)
  p3 <- added_variable_plot(data, model_p1, model_n1)
  p4 <- added_variable_plot(data, model_p1, model_o1)
  p5 <- added_variable_plot(data, model_p1, model_p.1)
  r5 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p.1, model_s1)
  p2 <- added_variable_plot(data, model_p.1, model_c1)
  p3 <- added_variable_plot(data, model_p.1, model_n1)
  p4 <- added_variable_plot(data, model_p.1, model_o1)
  p5 <- added_variable_plot(data, model_p.1, model_p1)
  r6 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  resid.plot.Kolkata <- ggarrange(r1,r2,r3,r4,r5,r6,nrow = 6) 
  
  p1 <- added_variable_plot(data, model_s2, model_n2)
  p2 <- added_variable_plot(data, model_s2, model_c2)
  p3 <- added_variable_plot(data, model_s2, model_o2)
  p4 <- added_variable_plot(data, model_s2, model_p2)
  p5 <- added_variable_plot(data, model_s2, model_p.2)
  r1 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_n2, model_s2)
  p2 <- added_variable_plot(data, model_n2, model_c2)
  p3 <- added_variable_plot(data, model_n2, model_o2)
  p4 <- added_variable_plot(data, model_n2, model_p2)
  p5 <- added_variable_plot(data, model_n2, model_p.2)
  r2 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_c2, model_s2)
  p2 <- added_variable_plot(data, model_c2, model_n2)
  p3 <- added_variable_plot(data, model_c2, model_o2)
  p4 <- added_variable_plot(data, model_c2, model_p2)
  p5 <- added_variable_plot(data, model_c2, model_p.2)
  r3 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_o2, model_s2)
  p2 <- added_variable_plot(data, model_o2, model_c2)
  p3 <- added_variable_plot(data, model_o2, model_n2)
  p4 <- added_variable_plot(data, model_o2, model_p2)
  p5 <- added_variable_plot(data, model_o2, model_p.2)
  r4 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p2, model_s2)
  p2 <- added_variable_plot(data, model_p2, model_c2)
  p3 <- added_variable_plot(data, model_p2, model_n2)
  p4 <- added_variable_plot(data, model_p2, model_o2)
  p5 <- added_variable_plot(data, model_p2, model_p.2)
  r5 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p.2, model_s2)
  p2 <- added_variable_plot(data, model_p.2, model_c2)
  p3 <- added_variable_plot(data, model_p.2, model_n2)
  p4 <- added_variable_plot(data, model_p.2, model_o2)
  p5 <- added_variable_plot(data, model_p.2, model_p2)
  r6 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  resid.plot.Delhi <- ggarrange(r1,r2,r3,r4,r5,r6,nrow = 6) 
  
  p1 <- added_variable_plot(data, model_s3, model_n3)
  p2 <- added_variable_plot(data, model_s3, model_c3)
  p3 <- added_variable_plot(data, model_s3, model_o3)
  p4 <- added_variable_plot(data, model_s3, model_p3)
  p5 <- added_variable_plot(data, model_s3, model_p.3)
  r1 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_n3, model_s3)
  p2 <- added_variable_plot(data, model_n3, model_c3)
  p3 <- added_variable_plot(data, model_n3, model_o3)
  p4 <- added_variable_plot(data, model_n3, model_p3)
  p5 <- added_variable_plot(data, model_n3, model_p.3)
  r2 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_c3, model_s3)
  p2 <- added_variable_plot(data, model_c3, model_n3)
  p3 <- added_variable_plot(data, model_c3, model_o3)
  p4 <- added_variable_plot(data, model_c3, model_p3)
  p5 <- added_variable_plot(data, model_c3, model_p.3)
  r3 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_o3, model_s3)
  p2 <- added_variable_plot(data, model_o3, model_c3)
  p3 <- added_variable_plot(data, model_o3, model_n3)
  p4 <- added_variable_plot(data, model_o3, model_p3)
  p5 <- added_variable_plot(data, model_o3, model_p.3)
  r4 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p3, model_s3)
  p2 <- added_variable_plot(data, model_p3, model_c3)
  p3 <- added_variable_plot(data, model_p3, model_n3)
  p4 <- added_variable_plot(data, model_p3, model_o3)
  p5 <- added_variable_plot(data, model_p3, model_p.3)
  r5 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p.3, model_s3)
  p2 <- added_variable_plot(data, model_p.3, model_c3)
  p3 <- added_variable_plot(data, model_p.3, model_n3)
  p4 <- added_variable_plot(data, model_p.3, model_o3)
  p5 <- added_variable_plot(data, model_p.3, model_p3)
  r6 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  resid.plot.Muzz <- ggarrange(r1,r2,r3,r4,r5,r6,nrow = 6) 
  
  p1 <- added_variable_plot(data, model_s4, model_n4)
  p2 <- added_variable_plot(data, model_s4, model_c4)
  p3 <- added_variable_plot(data, model_s4, model_o4)
  p4 <- added_variable_plot(data, model_s4, model_p4)
  p5 <- added_variable_plot(data, model_s4, model_p.4)
  r1 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_n4, model_s4)
  p2 <- added_variable_plot(data, model_n4, model_c4)
  p3 <- added_variable_plot(data, model_n4, model_o4)
  p4 <- added_variable_plot(data, model_n4, model_p4)
  p5 <- added_variable_plot(data, model_n4, model_p.4)
  r2 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_c4, model_s4)
  p2 <- added_variable_plot(data, model_c4, model_n4)
  p3 <- added_variable_plot(data, model_c4, model_o4)
  p4 <- added_variable_plot(data, model_c4, model_p4)
  p5 <- added_variable_plot(data, model_c4, model_p.4)
  r3 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_o4, model_s4)
  p2 <- added_variable_plot(data, model_o4, model_c4)
  p3 <- added_variable_plot(data, model_o4, model_n4)
  p4 <- added_variable_plot(data, model_o4, model_p4)
  p5 <- added_variable_plot(data, model_o4, model_p.4)
  r4 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p4, model_s4)
  p2 <- added_variable_plot(data, model_p4, model_c4)
  p3 <- added_variable_plot(data, model_p4, model_n4)
  p4 <- added_variable_plot(data, model_p4, model_o4)
  p5 <- added_variable_plot(data, model_p4, model_p.4)
  r5 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p.4, model_s4)
  p2 <- added_variable_plot(data, model_p.4, model_c4)
  p3 <- added_variable_plot(data, model_p.4, model_n4)
  p4 <- added_variable_plot(data, model_p.4, model_o4)
  p5 <- added_variable_plot(data, model_p.4, model_p4)
  r6 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  resid.plot.Mumbai <- ggarrange(r1,r2,r3,r4,r5,r6,nrow = 6) 
  
  return(list("resid.plot.Kolkata" = resid.plot.Kolkata, "resid.plot.Delhi"=resid.plot.Delhi, "resid.plot.Muzz"=resid.plot.Muzz, "resid.plot.Mumbai"=resid.plot.Mumbai))
}

# Training for 1 city
train_city_pol <- function(data, city = "City"){
  # so2 on non-pollutants
  model_s1 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  # no2 on non-pollutants
  model_n1 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  # co on non-pollutants
  model_c1 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  # o3 on non-pollutants
  model_o1 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  # pm10 on non-pollutants
  model_p1 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  # pm25 on non-pollutants
  model_p.1 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  R2.so2 <- tibble(
    city = find_R.squared(model_s1, data)
  )
  R2.no2 <- tibble(
    city = find_R.squared(model_n1, data)
  )
  R2.co <- tibble(
    city = find_R.squared(model_c1, data)
  )
  R2.o3 <- tibble(
    city = find_R.squared(model_o1, data)
  )
  R2.pm10 <- tibble(
    city = find_R.squared(model_p1, data)
  )
  R2.pm25 <- tibble(
    city = find_R.squared(model_p.1, data)
  )
  
  Prediction_Table <- full_join(full_join(full_join(full_join(full_join(R2.so2, R2.no2), R2.co), R2.o3), R2.pm10), R2.pm25)
  Prediction_Table.nonpol <- Prediction_Table %>%
    mutate(Pollutant = c("so2", "no2", "co", "o3", "pm10", "pm25")) %>%
    select(Pollutant, everything())
  
  model_summary.nonpol <- export_summs(model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1, error_format = "[{conf.low}, {conf.high}]", model.names = c("SO2", "NO2", "CO", "O3", "PM10", "PM25"))
  
  # so2 on pollutants
  model_s1 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data)
  
  # no2 on pollutants
  model_n1 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data)
  
  
  # co on pollutants
  model_c1 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data)
  
  
  # o3 on pollutants
  model_o1 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25, data = data)
  
  # pm10 on pollutants
  model_p1 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data)
  
  # pm25 on pollutants
  model_p.1 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data)
  
  R2.so2 <- tibble(
    city = find_R.squared(model_s1, data)
  )
  R2.no2 <- tibble(
    city = find_R.squared(model_n1, data)
  )
  R2.co <- tibble(
    city = find_R.squared(model_c1, data)
  )
  R2.o3 <- tibble(
    city = find_R.squared(model_o1, data)
  )
  R2.pm10 <- tibble(
    city = find_R.squared(model_p1, data)
  )
  R2.pm25 <- tibble(
    city = find_R.squared(model_p.1, data)
  )
  
  Prediction_Table <- full_join(full_join(full_join(full_join(full_join(R2.so2, R2.no2), R2.co), R2.o3), R2.pm10), R2.pm25)
  Prediction_Table.otherpol <- Prediction_Table %>%
    mutate(Pollutant = c("so2", "no2", "co", "o3", "pm10", "pm25")) %>%
    select(Pollutant, everything())
  
  model_summary.otherpol <- export_summs(model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1, error_format = "[{conf.low}, {conf.high}]", model.names = c("SO2", "NO2", "CO", "O3", "PM10", "PM25"))
  
  return(list("prediction.table.nonpol"=Prediction_Table.nonpol, "prediction.table.otherpol"=Prediction_Table.otherpol, "nonpolsummary"=model_summary.nonpol, "otherpolsummary"=model_summary.otherpol))
}

```

```{r helper_function_regression_actual}
# Making Predictions and checking distribution of residuals
make_predictions <- function(trained_model, test_data){
  predictions <- test_data %>%
    add_predictions(trained_model) %>%
    add_residuals(trained_model)
  p <- predictions %>%
    ggplot(aes(resid, ..density..)) +
    geom_histogram()
  return(p)
}

# Training for 1 city
train_city_pol <- function(data, city = "City"){
  # so2 on non-pollutants
  model_s1 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  # no2 on non-pollutants
  model_n1 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  # co on non-pollutants
  model_c1 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  # o3 on non-pollutants
  model_o1 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  # pm10 on non-pollutants
  model_p1 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  # pm25 on non-pollutants
  model_p.1 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data)
  
  R2.so2 <- tibble(
    city = find_R.squared(model_s1, data)
  )
  R2.no2 <- tibble(
    city = find_R.squared(model_n1, data)
  )
  R2.co <- tibble(
    city = find_R.squared(model_c1, data)
  )
  R2.o3 <- tibble(
    city = find_R.squared(model_o1, data)
  )
  R2.pm10 <- tibble(
    city = find_R.squared(model_p1, data)
  )
  R2.pm25 <- tibble(
    city = find_R.squared(model_p.1, data)
  )
  
  suppressMessages(Prediction_Table <- full_join(full_join(full_join(full_join(full_join(R2.so2, R2.no2), R2.co), R2.o3), R2.pm10), R2.pm25))
  Prediction_Table.nonpol <- Prediction_Table %>%
    mutate(Pollutant = c("so2", "no2", "co", "o3", "pm10", "pm25")) %>%
    select(Pollutant, everything())
  
  model_summary.nonpol <- export_summs(model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1, error_format = "[{conf.low}, {conf.high}]", model.names = c("SO2", "NO2", "CO", "O3", "PM10", "PM25"), number_format = "%.2f")
  
 
  
  return(list("prediction.table.nonpol"=Prediction_Table.nonpol, "nonpolsummary"=model_summary.nonpol))
}

train_city_pol_w_pol <- function(data, city = "City"){
  # so2 on pollutants
  model_s1 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data)
  
  # no2 on pollutants
  model_n1 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data)
  
  
  # co on pollutants
  model_c1 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data)
  
  
  # o3 on pollutants
  model_o1 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25, data = data)
  
  # pm10 on pollutants
  model_p1 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data)
  
  # pm25 on pollutants
  model_p.1 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data)
  
  R2.so2 <- tibble(
    city = find_R.squared(model_s1, data)
  )
  R2.no2 <- tibble(
    city = find_R.squared(model_n1, data)
  )
  R2.co <- tibble(
    city = find_R.squared(model_c1, data)
  )
  R2.o3 <- tibble(
    city = find_R.squared(model_o1, data)
  )
  R2.pm10 <- tibble(
    city = find_R.squared(model_p1, data)
  )
  R2.pm25 <- tibble(
    city = find_R.squared(model_p.1, data)
  )
  
  suppressMessages(Prediction_Table <- full_join(full_join(full_join(full_join(full_join(R2.so2, R2.no2), R2.co), R2.o3), R2.pm10), R2.pm25))
  Prediction_Table.otherpol <- Prediction_Table %>%
    mutate(Pollutant = c("so2", "no2", "co", "o3", "pm10", "pm25")) %>%
    select(Pollutant, everything())
  
  model_summary.otherpol <- export_summs(model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1, error_format = "[{conf.low}, {conf.high}]", model.names = c("SO2", "NO2", "CO", "O3", "PM10", "PM25"), number_format = "%.2f")
  
  return(list("prediction.table.otherpol"=Prediction_Table.otherpol, "otherpolsummary"=model_summary.otherpol))
}

# Training top 9 cities
train_all_cities_pol_with_nonpol <- function(data){
  # so2 on non-pollutants
  model_s1 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_s2 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_s3 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_s4 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # no2 on non-pollutants
  model_n1 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_n2 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_n3 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_n4 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # co on non-pollutants
  model_c1 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_c2 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_c3 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_c4 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # o3 on non-pollutants
  model_o1 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_o2 <<- lm(o3~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_o3 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_o4 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # pm10 on non-pollutants
  model_p1 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p2 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p3 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p4 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # pm25 on non-pollutants
  model_p.1 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p.2 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p.3 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p.4 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
}

train_all_cities_pol_with_otherpol <- function(data){
  # so2 on pollutants
  model_s1 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_s2 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_s3 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_s4 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  
  # no2 on pollutants
  model_n1 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_n2 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_n3 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_n4 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  
  
  # co on pollutants
  model_c1 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_c2 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_c3 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_c4 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  
  
  # o3 on pollutants
  model_o1 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_o2 <<- lm(o3~ so2 + no2 + co + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_o3 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_o4 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  
  # pm10 on pollutants
  model_p1 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Kolkata"))
  model_p2 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Delhi"))
  model_p3 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_p4 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Mumbai"))

  # pm25 on non-pollutants
  model_p.1 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data %>% filter(City == "Kolkata"))
  model_p.2 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data %>% filter(City == "Delhi"))
  model_p.3 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data %>% filter(City == "Muzaffarnagar"))
  model_p.4 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data %>% filter(City == "Mumbai"))
  
}

full_train_all_cities_pol <- function(data){
  # so2 on non-pollutants
  model_s1 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_s2 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_s3 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_s4 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # no2 on non-pollutants
  model_n1 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_n2 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_n3 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_n4 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # co on non-pollutants
  model_c1 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_c2 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_c3 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_c4 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # o3 on non-pollutants
  model_o1 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_o2 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_o3 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_o4 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))

  # pm10 on non-pollutants
  model_p1 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p2 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p3 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p4 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  
  # pm25 on non-pollutants
  model_p.1 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p.2 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p.3 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p.4 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10 + dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))

}

# Training top 9 cities
train_all_cities_pol_with_nonpol_wl <- function(data){
  # so2 on non-pollutants
  model_s1 <<- lm(log(so2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_s2 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_s3 <<- lm(log(so2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_s4 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  model_s5 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  model_s6 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_s7 <<- lm(log(so2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_s8 <<- lm(so2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_s9 <<- lm(log(so2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_s1)
  summary(model_s2)
  summary(model_s3)
  summary(model_s4)
  summary(model_s5)
  summary(model_s6)
  summary(model_s7)
  summary(model_s8)
  summary(model_s9)
  
  # no2 on non-pollutants
  model_n1 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_n2 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_n3 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_n4 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  model_n5 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  model_n6 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_n7 <<- lm(log(no2) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_n8 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_n9 <<- lm(no2 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_n1)
  summary(model_n2)
  summary(model_n3)
  summary(model_n4)
  summary(model_n5)
  summary(model_n6)
  summary(model_n7)
  summary(model_n8)
  summary(model_n9)
  
  # co on non-pollutants
  model_c1 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_c2 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_c3 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_c4 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  model_c5 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  model_c6 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_c7 <<- lm(log(co) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_c8 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_c9 <<- lm(co ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_c1)
  summary(model_c2)
  summary(model_c3)
  summary(model_c4)
  summary(model_c5)
  summary(model_c6)
  summary(model_c7)
  summary(model_c8)
  summary(model_c9)
  
  # o3 on non-pollutants
  model_o1 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_o2 <<- lm(log(o3)~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_o3 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_o4 <<- lm(log(o3) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  model_o5 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  model_o6 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_o7 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_o8 <<- lm(log(o3) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_o9 <<- lm(o3 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_o1)
  summary(model_o2)
  summary(model_o3)
  summary(model_o4)
  summary(model_o5)
  summary(model_o6)
  summary(model_o7)
  summary(model_o8)
  summary(model_o9)
  
  # pm10 on non-pollutants
  model_p1 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p2 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p3 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p4 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  #model_p5 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  #model_p6 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_p7 <<- lm(pm10 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_p8 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_p9 <<- lm(log(pm10) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_p1)
  summary(model_p2)
  summary(model_p3)
  summary(model_p4)
  #summary(model_p5)
  #summary(model_p6)
  summary(model_p7)
  summary(model_p8)
  summary(model_p9)
  
  # pm25 on non-pollutants
  model_p.1 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Kolkata"))
  model_p.2 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Delhi"))
  model_p.3 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Muzaffarnagar"))
  model_p.4 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Mumbai"))
  model_p.5 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Lucknow"))
  model_p.6 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Patna"))
  model_p.7 <<- lm(pm25 ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Chandigarh"))
  model_p.8 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Gandhinagar"))
  model_p.9 <<- lm(log(pm25) ~ dew + humidity + pressure + temperature + `wind-speed`, data = data %>% filter(City == "Jaipur"))
  
  summary(model_p.1)
  summary(model_p.2)
  summary(model_p.3)
  summary(model_p.4)
  summary(model_p.5)
  summary(model_p.6)
  summary(model_p.7)
  summary(model_p.8)
  invisible(summary(model_p.9))
}

train_all_cities_pol_with_otherpol_wl <- function(data){
  # so2 on pollutants
  model_s1 <<- lm(log(so2) ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_s2 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_s3 <<- lm(log(so2) ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_s4 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  model_s5 <<- lm(so2 ~ no2 + co + o3 + pm25, data = data %>% filter(City == "Lucknow"))
  model_s6 <<- lm(so2 ~ no2 + co + o3 + pm25, data = data %>% filter(City == "Patna"))
  model_s7 <<- lm(log(so2) ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Chandigarh"))
  model_s8 <<- lm(so2 ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Gandhinagar"))
  model_s9 <<- lm(log(so2) ~ no2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Jaipur"))
  
  summary(model_s1)
  summary(model_s2)
  summary(model_s3)
  summary(model_s4)
  summary(model_s5)
  summary(model_s6)
  summary(model_s7)
  summary(model_s8)
  summary(model_s9)
  
  # no2 on pollutants
  model_n1 <<- lm(no2 ~ log(so2) + co + o3 + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_n2 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_n3 <<- lm(no2 ~ log(so2) + co + o3 + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_n4 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  model_n5 <<- lm(no2 ~ so2 + co + o3 + pm25, data = data %>% filter(City == "Lucknow"))
  model_n6 <<- lm(no2 ~ so2 + co + o3 + pm25, data = data %>% filter(City == "Patna"))
  model_n7 <<- lm(no2 ~ log(so2) + co + o3 + pm10 + pm25, data = data %>% filter(City == "Chandigarh"))
  model_n8 <<- lm(no2 ~ so2 + co + o3 + pm10 + pm25, data = data %>% filter(City == "Gandhinagar"))
  model_n9 <<- lm(no2 ~ log(so2) + co + o3 + pm10 + pm25, data = data %>% filter(City == "Jaipur"))
  
  summary(model_n1)
  summary(model_n2)
  summary(model_n3)
  summary(model_n4)
  summary(model_n5)
  summary(model_n6)
  summary(model_n7)
  summary(model_n8)
  summary(model_n9)
  
  # co on pollutants
  model_c1 <<- lm(co ~ log(so2) + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_c2 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_c3 <<- lm(co ~ log(so2) + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_c4 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  model_c5 <<- lm(co ~ so2 + no2 + o3 + pm25, data = data %>% filter(City == "Lucknow"))
  model_c6 <<- lm(co ~ so2 + no2 + o3 + pm25, data = data %>% filter(City == "Patna"))
  model_c7 <<- lm(co ~ log(so2) + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Chandigarh"))
  model_c8 <<- lm(co ~ so2 + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Gandhinagar"))
  model_c9 <<- lm(co ~ log(so2) + no2 + o3 + pm10 + pm25, data = data %>% filter(City == "Jaipur"))
  
  summary(model_c1)
  summary(model_c2)
  summary(model_c3)
  summary(model_c4)
  summary(model_c5)
  summary(model_c6)
  summary(model_c7)
  summary(model_c8)
  summary(model_c9)
  
  # o3 on pollutants
  model_o1 <<- lm(o3 ~ log(so2) + no2 + co + pm10 + pm25, data = data %>% filter(City == "Kolkata"))
  model_o2 <<- lm(o3~ so2 + no2 + co + pm10 + pm25, data = data %>% filter(City == "Delhi"))
  model_o3 <<- lm(o3 ~ log(so2) + no2 + co + pm10 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_o4 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25, data = data %>% filter(City == "Mumbai"))
  model_o5 <<- lm(o3 ~ so2 + no2 + co + pm25, data = data %>% filter(City == "Lucknow"))
  model_o6 <<- lm(o3 ~ so2 + no2 + co + pm25, data = data %>% filter(City == "Patna"))
  model_o7 <<- lm(o3 ~ log(so2) + no2 + co + pm10 + pm25, data = data %>% filter(City == "Chandigarh"))
  model_o8 <<- lm(o3 ~ so2 + no2 + co + pm10 + pm25, data = data %>% filter(City == "Gandhinagar"))
  model_o9 <<- lm(o3 ~ log(so2) + no2 + co + pm10 + pm25, data = data %>% filter(City == "Jaipur"))
  
  summary(model_o1)
  summary(model_o2)
  summary(model_o3)
  summary(model_o4)
  summary(model_o5)
  summary(model_o6)
  summary(model_o7)
  summary(model_o8)
  summary(model_o9)
  
  # pm10 on pollutants
  model_p1 <<- lm(pm10 ~ log(so2) + no2 + co + o3 + pm25, data = data %>% filter(City == "Kolkata"))
  model_p2 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Delhi"))
  model_p3 <<- lm(pm10 ~ log(so2) + no2 + co + o3 + pm25, data = data %>% filter(City == "Muzaffarnagar"))
  model_p4 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Mumbai"))
  #model_p5 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Lucknow"))
  #model_p6 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Patna"))
  model_p7 <<- lm(pm10 ~ log(so2) + no2 + co + o3 + pm25, data = data %>% filter(City == "Chandigarh"))
  model_p8 <<- lm(pm10 ~ so2 + no2 + co + o3 + pm25, data = data %>% filter(City == "Gandhinagar"))
  model_p9 <<- lm(pm10 ~ log(so2) + no2 + co + o3 + pm25, data = data %>% filter(City == "Jaipur"))
  
  summary(model_p1)
  summary(model_p2)
  summary(model_p3)
  summary(model_p4)
  #summary(model_p5)
  #summary(model_p6)
  summary(model_p7)
  summary(model_p8)
  summary(model_p9)
  
  # pm25 on non-pollutants
  model_p.1 <<- lm(pm25 ~ log(so2) + no2 + co + o3 + pm10, data = data %>% filter(City == "Kolkata"))
  model_p.2 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data %>% filter(City == "Delhi"))
  model_p.3 <<- lm(pm25 ~ log(so2) + no2 + co + o3 + pm10, data = data %>% filter(City == "Muzaffarnagar"))
  model_p.4 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data %>% filter(City == "Mumbai"))
  model_p.5 <<- lm(pm25 ~ so2 + no2 + co + o3, data = data %>% filter(City == "Lucknow"))
  model_p.6 <<- lm(pm25 ~ so2 + no2 + co + o3, data = data %>% filter(City == "Patna"))
  model_p.7 <<- lm(pm25 ~ log(so2) + no2 + co + o3 + pm10, data = data %>% filter(City == "Chandigarh"))
  model_p.8 <<- lm(pm25 ~ so2 + no2 + co + o3 + pm10, data = data %>% filter(City == "Gandhinagar"))
  model_p.9 <<- lm(pm25 ~ log(so2) + no2 + co + o3 + pm10, data = data %>% filter(City == "Jaipur"))
  
  summary(model_p.1)
  summary(model_p.2)
  summary(model_p.3)
  summary(model_p.4)
  summary(model_p.5)
  summary(model_p.6)
  summary(model_p.7)
  summary(model_p.8)
  invisible(summary(model_p.9))
}

# Print all City Model Summaries
print_all_city_model_summary <- function(){

  model_so2 <- export_summs(model_s1, model_s2, model_s3, model_s4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))
  model_no2 <- export_summs(model_n1, model_n2, model_n3, model_n4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))
  model_co <- export_summs(model_c1, model_c2, model_c3, model_c4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))
  model_o3 <- export_summs(model_o1, model_o2, model_o3, model_o4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))
  model_pm10 <- export_summs(model_p1, model_p2, model_p3, model_p4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))
  model_pm25 <- export_summs(model_p.1, model_p.2, model_p.3, model_p.4, error_format = "[{conf.low}, {conf.high}]", model.names = c("Kolkata", "Delhi", "Muzaffarnagar", "Mumbai"))

  return(list("model_so2"=model_so2, "model_no2"=model_no2, "model_co"=model_co, "model_o3"=model_o3, "model_pm10"=model_pm10, "model_pm25"=model_pm25))
}

# Predicting top 9 cities pollutants from non pol trained data
predict_all_cities_pol <- function(data){
  # Non-pollutants based predictions --- MAKE SURE THE model_s1 and all model used in this part is trained with non-pollutants
  
  # So2 Level prediction
  p1 <- make_predictions(model_s1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_s2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_s3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_s4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_so2 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # No2 Level prediction
  p1 <- make_predictions(model_n1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_n2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_n3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_n4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_no2 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # CO Level prediction
  p1 <- make_predictions(model_c1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_c2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_c3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_c4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_co <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # O3 Level prediction
  p1 <- make_predictions(model_o1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_o2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_o3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_o4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_o3 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # pm10 Level prediction
  p1 <- make_predictions(model_p1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_p2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_p3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_p4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_pm10 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  # pm25 Level prediction
  p1 <- make_predictions(model_p.1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_p.2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  p3 <- make_predictions(model_p.3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  p4 <- make_predictions(model_p.4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_pm25 <- ggarrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
  
  return(list("res_so2"=res_so2, "res_no2"=res_no2, "res_co"=res_co, "res_o3"=res_o3, "res_pm10"=res_pm10, "res_pm25"=res_pm25))
}

# Test Data R^2
find_R.squared <- function(model, data){
  predictions <- data %>%
    add_predictions(model)
  predictions <- predictions %>%
    filter(!is.na(pred))
  y <- as.data.frame(predictions[,model$terms[[2]]])[,1]
  R.squared <- cor(predictions$pred, y)^2
  return(R.squared)
}

# Test Data R^2 Print
print_all_cities_R.squared <- function(data){
  R2.so2 <- tibble(
    "Kolkata" = find_R.squared(model_s1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_s2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_s3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_s4, data %>% filter(City == "Mumbai")),
  )
  R2.no2 <- tibble(
    "Kolkata" = find_R.squared(model_n1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_n2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_n3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_n4, data %>% filter(City == "Mumbai")),
  )
  R2.co <- tibble(
    "Kolkata" = find_R.squared(model_c1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_c2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_c3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_c4, data %>% filter(City == "Mumbai")),
  )
  R2.o3 <- tibble(
    "Kolkata" = find_R.squared(model_o1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_o2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_o3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_o4, data %>% filter(City == "Mumbai")),
  )
  R2.pm10 <- tibble(
    "Kolkata" = find_R.squared(model_p1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_p2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_p3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_p4, data %>% filter(City == "Mumbai")),
  )
  R2.pm25 <- tibble(
    "Kolkata" = find_R.squared(model_p.1, data %>% filter(City == "Kolkata")),
    "Delhi" = find_R.squared(model_p.2, data %>% filter(City == "Delhi")),
    "Muzaffarnagar" = find_R.squared(model_p.3, data %>% filter(City == "Muzaffarnagar")),
    "Mumbai" = find_R.squared(model_p.4, data %>% filter(City == "Mumbai")),
  )
  
  Prediction_Table <- full_join(full_join(full_join(full_join(full_join(R2.so2, R2.no2), R2.co), R2.o3), R2.pm10), R2.pm25)
  Prediction_Table <- Prediction_Table %>%
    mutate(Pollutant = c("so2", "no2", "co", "o3", "pm10", "pm25")) %>%
    select(Pollutant, everything())
  return(list("R2.so2" = R2.so2, "R2.no2" = R2.no2, "R2.co" = R2.co, "R2.o3" = R2.o3, "R2.pm10" = R2.pm10, "R2.pm25" = R2.pm25, "Prediction_Table" = Prediction_Table))
}

# Added Variable Plot
added_variable_plot <- function(data, model_1, model_2){
  residuals <- data %>%
    add_residuals(model_1, var = "resid_1") %>%
    add_residuals(model_2, var = "resid_2")
  
  p1 <- residuals %>%
    ggplot(aes(resid_1, resid_2)) +
    geom_point() +
    labs(
      x = paste(model_1$terms[[2]], "resid"),
      y = paste(model_2$terms[[2]], "resid")
    )
  print(p1)
}

# Added Variable Plots All Cities
added_variable_plot_all_cities <- function(data){
  p1 <- added_variable_plot(data, model_s1, model_n1)
  p2 <- added_variable_plot(data, model_s1, model_c1)
  p3 <- added_variable_plot(data, model_s1, model_o1)
  p4 <- added_variable_plot(data, model_s1, model_p1)
  p5 <- added_variable_plot(data, model_s1, model_p.1)
  r1 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_n1, model_s1)
  p2 <- added_variable_plot(data, model_n1, model_c1)
  p3 <- added_variable_plot(data, model_n1, model_o1)
  p4 <- added_variable_plot(data, model_n1, model_p1)
  p5 <- added_variable_plot(data, model_n1, model_p.1)
  r2 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_c1, model_s1)
  p2 <- added_variable_plot(data, model_c1, model_n1)
  p3 <- added_variable_plot(data, model_c1, model_o1)
  p4 <- added_variable_plot(data, model_c1, model_p1)
  p5 <- added_variable_plot(data, model_c1, model_p.1)
  r3 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_o1, model_s1)
  p2 <- added_variable_plot(data, model_o1, model_c1)
  p3 <- added_variable_plot(data, model_o1, model_n1)
  p4 <- added_variable_plot(data, model_o1, model_p1)
  p5 <- added_variable_plot(data, model_o1, model_p.1)
  r4 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p1, model_s1)
  p2 <- added_variable_plot(data, model_p1, model_c1)
  p3 <- added_variable_plot(data, model_p1, model_n1)
  p4 <- added_variable_plot(data, model_p1, model_o1)
  p5 <- added_variable_plot(data, model_p1, model_p.1)
  r5 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p.1, model_s1)
  p2 <- added_variable_plot(data, model_p.1, model_c1)
  p3 <- added_variable_plot(data, model_p.1, model_n1)
  p4 <- added_variable_plot(data, model_p.1, model_o1)
  p5 <- added_variable_plot(data, model_p.1, model_p1)
  r6 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  resid.plot.Kolkata <- ggarrange(r1,r2,r3,r4,r5,r6,nrow = 6) 
  
  p1 <- added_variable_plot(data, model_s2, model_n2)
  p2 <- added_variable_plot(data, model_s2, model_c2)
  p3 <- added_variable_plot(data, model_s2, model_o2)
  p4 <- added_variable_plot(data, model_s2, model_p2)
  p5 <- added_variable_plot(data, model_s2, model_p.2)
  r1 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_n2, model_s2)
  p2 <- added_variable_plot(data, model_n2, model_c2)
  p3 <- added_variable_plot(data, model_n2, model_o2)
  p4 <- added_variable_plot(data, model_n2, model_p2)
  p5 <- added_variable_plot(data, model_n2, model_p.2)
  r2 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_c2, model_s2)
  p2 <- added_variable_plot(data, model_c2, model_n2)
  p3 <- added_variable_plot(data, model_c2, model_o2)
  p4 <- added_variable_plot(data, model_c2, model_p2)
  p5 <- added_variable_plot(data, model_c2, model_p.2)
  r3 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_o2, model_s2)
  p2 <- added_variable_plot(data, model_o2, model_c2)
  p3 <- added_variable_plot(data, model_o2, model_n2)
  p4 <- added_variable_plot(data, model_o2, model_p2)
  p5 <- added_variable_plot(data, model_o2, model_p.2)
  r4 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p2, model_s2)
  p2 <- added_variable_plot(data, model_p2, model_c2)
  p3 <- added_variable_plot(data, model_p2, model_n2)
  p4 <- added_variable_plot(data, model_p2, model_o2)
  p5 <- added_variable_plot(data, model_p2, model_p.2)
  r5 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p.2, model_s2)
  p2 <- added_variable_plot(data, model_p.2, model_c2)
  p3 <- added_variable_plot(data, model_p.2, model_n2)
  p4 <- added_variable_plot(data, model_p.2, model_o2)
  p5 <- added_variable_plot(data, model_p.2, model_p2)
  r6 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  resid.plot.Delhi <- ggarrange(r1,r2,r3,r4,r5,r6,nrow = 6) 
  
  p1 <- added_variable_plot(data, model_s3, model_n3)
  p2 <- added_variable_plot(data, model_s3, model_c3)
  p3 <- added_variable_plot(data, model_s3, model_o3)
  p4 <- added_variable_plot(data, model_s3, model_p3)
  p5 <- added_variable_plot(data, model_s3, model_p.3)
  r1 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_n3, model_s3)
  p2 <- added_variable_plot(data, model_n3, model_c3)
  p3 <- added_variable_plot(data, model_n3, model_o3)
  p4 <- added_variable_plot(data, model_n3, model_p3)
  p5 <- added_variable_plot(data, model_n3, model_p.3)
  r2 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_c3, model_s3)
  p2 <- added_variable_plot(data, model_c3, model_n3)
  p3 <- added_variable_plot(data, model_c3, model_o3)
  p4 <- added_variable_plot(data, model_c3, model_p3)
  p5 <- added_variable_plot(data, model_c3, model_p.3)
  r3 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_o3, model_s3)
  p2 <- added_variable_plot(data, model_o3, model_c3)
  p3 <- added_variable_plot(data, model_o3, model_n3)
  p4 <- added_variable_plot(data, model_o3, model_p3)
  p5 <- added_variable_plot(data, model_o3, model_p.3)
  r4 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p3, model_s3)
  p2 <- added_variable_plot(data, model_p3, model_c3)
  p3 <- added_variable_plot(data, model_p3, model_n3)
  p4 <- added_variable_plot(data, model_p3, model_o3)
  p5 <- added_variable_plot(data, model_p3, model_p.3)
  r5 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p.3, model_s3)
  p2 <- added_variable_plot(data, model_p.3, model_c3)
  p3 <- added_variable_plot(data, model_p.3, model_n3)
  p4 <- added_variable_plot(data, model_p.3, model_o3)
  p5 <- added_variable_plot(data, model_p.3, model_p3)
  r6 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  resid.plot.Muzz <- ggarrange(r1,r2,r3,r4,r5,r6,nrow = 6) 
  
  p1 <- added_variable_plot(data, model_s4, model_n4)
  p2 <- added_variable_plot(data, model_s4, model_c4)
  p3 <- added_variable_plot(data, model_s4, model_o4)
  p4 <- added_variable_plot(data, model_s4, model_p4)
  p5 <- added_variable_plot(data, model_s4, model_p.4)
  r1 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_n4, model_s4)
  p2 <- added_variable_plot(data, model_n4, model_c4)
  p3 <- added_variable_plot(data, model_n4, model_o4)
  p4 <- added_variable_plot(data, model_n4, model_p4)
  p5 <- added_variable_plot(data, model_n4, model_p.4)
  r2 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_c4, model_s4)
  p2 <- added_variable_plot(data, model_c4, model_n4)
  p3 <- added_variable_plot(data, model_c4, model_o4)
  p4 <- added_variable_plot(data, model_c4, model_p4)
  p5 <- added_variable_plot(data, model_c4, model_p.4)
  r3 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_o4, model_s4)
  p2 <- added_variable_plot(data, model_o4, model_c4)
  p3 <- added_variable_plot(data, model_o4, model_n4)
  p4 <- added_variable_plot(data, model_o4, model_p4)
  p5 <- added_variable_plot(data, model_o4, model_p.4)
  r4 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p4, model_s4)
  p2 <- added_variable_plot(data, model_p4, model_c4)
  p3 <- added_variable_plot(data, model_p4, model_n4)
  p4 <- added_variable_plot(data, model_p4, model_o4)
  p5 <- added_variable_plot(data, model_p4, model_p.4)
  r5 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  p1 <- added_variable_plot(data, model_p.4, model_s4)
  p2 <- added_variable_plot(data, model_p.4, model_c4)
  p3 <- added_variable_plot(data, model_p.4, model_n4)
  p4 <- added_variable_plot(data, model_p.4, model_o4)
  p5 <- added_variable_plot(data, model_p.4, model_p4)
  r6 <- ggarrange(p1,p2, p3, p4, p5, nrow = 1)
  resid.plot.Mumbai <- ggarrange(r1,r2,r3,r4,r5,r6,nrow = 6) 
  
  return(list("resid.plot.Kolkata" = resid.plot.Kolkata, "resid.plot.Delhi"=resid.plot.Delhi, "resid.plot.Muzz"=resid.plot.Muzz, "resid.plot.Mumbai"=resid.plot.Mumbai))
}


format_reg_table <- function(model, digs = 2){
  mod <- tidy(model, conf.level = .99, conf.int = TRUE) %>%
    mutate(across(where(is.numeric), ~ round(., digits = digs)))
  mod <- mod %>%
    mutate(estimate = as.character(estimate)) %>%
    mutate(estimate = paste(paste(estimate, ifelse(p.value < 0.05, "*",""), ifelse(p.value < 0.01, "*",""), ifelse(p.value < 0.001, "*",""), sep = ""), paste("[", conf.low, ", ", conf.high, "]", sep = ""), sep = "\n"))
  mod <- mod %>%
    select(term, estimate)
  return(mod)
}

present_all_pols_model <- function(data, model_s, model_n, model_c, model_o, model_p, model_p.){
  mod1 <- format_reg_table(model_s) %>% rename(SO2 = estimate)
  mod2 <- format_reg_table(model_n) %>% select(estimate) %>% rename(NO2 = estimate)
  mod3 <- format_reg_table(model_c) %>% select(estimate) %>% rename(CO = estimate)
  mod4 <- format_reg_table(model_o) %>% select(estimate) %>% rename(O3 = estimate)
  mod5 <- format_reg_table(model_p) %>% select(estimate) %>% rename(PM10 = estimate)
  mod6 <- format_reg_table(model_p.) %>% select(estimate) %>% rename(PM25 = estimate)
  
  R2table <<- tibble(term = c("R2"), SO2 = c(find_R.squared(model_s, data)), NO2 = c(find_R.squared(model_n, data)), CO = c(find_R.squared(model_c, data)), O3 = c(find_R.squared(model_o, data)), PM10 = c(find_R.squared(model_p, data)), PM25 = c(find_R.squared(model_p., data)))
  R2table <<- R2table %>%
    mutate(across(where(is.numeric), ~ round(., digits = 2))) %>%
    mutate(across(where(is.numeric), ~ as.character(.)))
  
  suppressMessages(fin.table <<- as_tibble(cbind(mod1, mod2, mod3, mod4, mod5, mod6)) %>%
    full_join(R2table))
  return(fin.table)
}

present_all_pols_otherpols_model <- function(data, model_s, model_n, model_c, model_o, model_p, model_p.){
  mod1 <- format_reg_table(model_s) %>% select(estimate) %>% rename(SO2 = estimate)
  mod2 <- format_reg_table(model_n) %>% select(estimate) %>% rename(NO2 = estimate)
  mod3 <- format_reg_table(model_c) %>% select(estimate) %>% rename(CO = estimate)
  mod4 <- format_reg_table(model_o) %>% select(estimate) %>% rename(O3 = estimate)
  mod5 <- format_reg_table(model_p) %>% select(estimate) %>% rename(PM10 = estimate)
  mod6 <- format_reg_table(model_p.) %>% select(estimate) %>% rename(PM25 = estimate)
  
  mod <- tibble(
    term = c("(Intercept)", "SO2", "NO2", "CO", "O3", "PM10", "PM25"),
    SO2 = c(mod1$SO2[1], NA, mod1$SO2[2:nrow(mod1)]),
    NO2 = c(mod2$NO2[1:2], NA, mod2$NO2[3:nrow(mod2)]),
    CO = c(mod3$CO[1:3], NA, mod3$CO[4:nrow(mod3)]),
    O3 = c(mod4$O3[1:4], NA, mod4$O3[5:nrow(mod4)]),
    PM10 = c(mod5$PM10[1:5], NA, mod5$PM10[6:nrow(mod5)]),
    PM25 = c(mod6$PM25[1:nrow(mod6)], NA),
  )
  
  R2table <<- tibble(term = c("R2"), SO2 = c(find_R.squared(model_s, data)), NO2 = c(find_R.squared(model_n, data)), CO = c(find_R.squared(model_c, data)), O3 = c(find_R.squared(model_o, data)), PM10 = c(find_R.squared(model_p, data)), PM25 = c(find_R.squared(model_p., data)))
  R2table <<- R2table %>%
    mutate(across(where(is.numeric), ~ round(., digits = 2))) %>%
    mutate(across(where(is.numeric), ~ as.character(.)))
  
  suppressMessages(fin.table <<- mod %>%
                     full_join(R2table))
  return(fin.table)
}

# Presenting Model Summary Concisely.
present_model_summary <- function(data, city_name = "Kolkata"){ # The Data must be Yearly
  
  # Kolkata
  # On weather params
  invisible(capture.output(kol <- train_city_pol(data %>% filter(City == city_name, Month %in% c(1,2,3,4,5,6)))))
  nonpol_model_1 <<- present_all_pols_model(data %>% filter(City == city_name, Month %in% c(1,2,3,4,5,6)), model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1)
  
  invisible(capture.output(kol <- train_city_pol(data %>% filter(City == city_name, Month %in% c(7,8,9,10,11,12)))))
  nonpol_model_2 <<- present_all_pols_model(data %>% filter(City == city_name, Month %in% c(7,8,9,10,11,12)), model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1)
  
  nonpol_model_1 <- ggtexttable(nonpol_model_1, rows = NULL, theme = ttheme("mGreen")) %>%
    tab_add_title("First Half of the Year (Pollutant Levels On Weather Parameters)", face = "bold") %>%
    tab_add_footnote(text = "*** p < 0.001; ** p < 0.01; * p < 0.05; 99% confidence Intervals", size = 10, face = "italic")
  nonpol_model_2 <- ggtexttable(nonpol_model_2, rows = NULL, theme = ttheme("mBlue")) %>%
    tab_add_title("Second Half of the Year (Pollutant Levels on Weather Parameters)", face = "bold") %>%
    tab_add_footnote(text = "*** p < 0.001; ** p < 0.01; * p < 0.05; 99% confidence Intervals", size = 10, face = "italic")
  
  # On other Pols
  invisible(capture.output(kol <- train_city_pol_w_pol(data %>% filter(City == city_name, Month %in% c(1,2,3,4,5,6)))))
  pol_model_1 <<- present_all_pols_otherpols_model(data %>% filter(City == city_name, Month %in% c(1,2,3,4,5,6)), model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1)
  
  invisible(capture.output(kol <- train_city_pol_w_pol(data %>% filter(City == city_name, Month %in% c(7,8,9,10,11,12)))))
  pol_model_2 <<- present_all_pols_otherpols_model(data %>% filter(City == city_name, Month %in% c(7,8,9,10,11,12)), model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1)
  
  pol_model_1 <- ggtexttable(pol_model_1, rows = NULL, theme = ttheme("mOrange")) %>%
    tab_add_title("First Half of the Year (Pollutant Levels on Other Pollutant Levels)", face = "bold") %>%
    tab_add_footnote(text = "*** p < 0.001; ** p < 0.01; * p < 0.05; 99% confidence Intervals", size = 10, face = "italic")
  pol_model_2 <- ggtexttable(pol_model_2, rows = NULL, theme = ttheme("mRed")) %>%
    tab_add_title("Second Half of the Year (Pollutant Levels on Other Pollutant Levels)", face = "bold") %>%
    tab_add_footnote(text = "*** p < 0.001; ** p < 0.01; * p < 0.05; 99% confidence Intervals", size = 10, face = "italic")
  
  
  kolkata <- annotate_figure(ggarrange(nonpol_model_1, pol_model_1, nonpol_model_2, pol_model_2, nrow = 2, ncol = 2), top = text_grob(city_name, face = "bold", size = 14))
  return(kolkata)
  
}

present_model_summary_Delhi <- function(data){ # The Data must be Yearly
  
  # Delhi
  # On weather params
  invisible(capture.output(kol <- train_city_pol(data %>% filter(City == "Delhi", Month %in% c(1,2,3,4,5,6)))))
  nonpol_model_1 <<- present_all_pols_model(data %>% filter(City == "Delhi", Month %in% c(1,2,3,4,5,6)), model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1)
  
  invisible(capture.output(kol <- train_city_pol(data %>% filter(City == "Delhi", Month %in% c(7,8,9,10,11,12)))))
  nonpol_model_2 <<- present_all_pols_model(data %>% filter(City == "Delhi", Month %in% c(7,8,9,10,11,12)), model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1)
  
  nonpol_model_1 <- ggtexttable(nonpol_model_1, rows = NULL, theme = ttheme("mGreen")) %>%
    tab_add_title("First Half of the Year (Pollutant Levels On Weather Parameters)", face = "bold") %>%
    tab_add_footnote(text = "*** p < 0.001; ** p < 0.01; * p < 0.05; 99% confidence Intervals", size = 10, face = "italic")
  nonpol_model_2 <- ggtexttable(nonpol_model_2, rows = NULL, theme = ttheme("mBlue")) %>%
    tab_add_title("Second Half of the Year (Pollutant Levels on Weather Parameters)", face = "bold") %>%
    tab_add_footnote(text = "*** p < 0.001; ** p < 0.01; * p < 0.05; 99% confidence Intervals", size = 10, face = "italic")
  
  # On other Pols
  invisible(capture.output(kol <- train_city_pol_w_pol(data %>% filter(City == "Delhi", Month %in% c(1,2,3,4,5,6)))))
  pol_model_1 <<- present_all_pols_otherpols_model(data %>% filter(City == "Delhi", Month %in% c(1,2,3,4,5,6)), model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1)
  
  invisible(capture.output(kol <- train_city_pol_w_pol(data %>% filter(City == "Delhi", Month %in% c(7,8,9,10,11,12)))))
  pol_model_2 <<- present_all_pols_otherpols_model(data %>% filter(City == "Delhi", Month %in% c(7,8,9,10,11,12)), model_s1, model_n1, model_c1, model_o1, model_p1, model_p.1)
  
  pol_model_1 <- ggtexttable(pol_model_1, rows = NULL, theme = ttheme("mOrange")) %>%
    tab_add_title("First Half of the Year (Pollutant Levels on Other Pollutant Levels)", face = "bold") %>%
    tab_add_footnote(text = "*** p < 0.001; ** p < 0.01; * p < 0.05; 99% confidence Intervals", size = 10, face = "italic")
  pol_model_2 <- ggtexttable(pol_model_2, rows = NULL, theme = ttheme("mRed")) %>%
    tab_add_title("Second Half of the Year (Pollutant Levels on Other Pollutant Levels)", face = "bold") %>%
    tab_add_footnote(text = "*** p < 0.001; ** p < 0.01; * p < 0.05; 99% confidence Intervals", size = 10, face = "italic")
  
  
  Delhi <- annotate_figure(ggarrange(nonpol_model_1, pol_model_1, nonpol_model_2, pol_model_2, nrow = 2, ncol = 2), top = text_grob("Delhi", face = "bold", size = 14))
  
}

# Making Predictions and checking distribution of residuals
make_predictions <- function(trained_model, test_data){
  predictions <- test_data %>%
    add_predictions(trained_model) %>%
    add_residuals(trained_model)
  p <- predictions %>%
    ggplot(aes(resid, ..density..)) +
    geom_histogram() + 
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), axis.line = element_line(colour = "black"),strip.background = element_blank())
  return(p)
}

# Predicting top 9 cities pollutants from non pol trained data
predict_all_cities_pol <- function(data){
  # Non-pollutants based predictions --- MAKE SURE THE model_s1 and all model used in this part is trained with non-pollutants
  
  # So2 Level prediction
  p1 <- make_predictions(model_s1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_s2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  #p3 <- make_predictions(model_s3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  #p4 <- make_predictions(model_s4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_so2 <- annotate_figure(ggarrange(p1,p2, nrow = 1, ncol = 2), top = text_grob("SO2 Residuals", face = "bold", size = 16))
  
  # No2 Level prediction
  p1 <- make_predictions(model_n1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_n2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  #p3 <- make_predictions(model_n3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  #p4 <- make_predictions(model_n4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_no2 <- annotate_figure(ggarrange(p1,p2, nrow = 1, ncol = 2), top = text_grob("NO2 Residuals", face = "bold", size = 16))
  
  # CO Level prediction
  p1 <- make_predictions(model_c1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_c2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  #p3 <- make_predictions(model_c3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  #p4 <- make_predictions(model_c4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_co <- annotate_figure(ggarrange(p1,p2, nrow = 1, ncol = 2), top = text_grob("CO Residuals", face = "bold", size = 16))
  
  # O3 Level prediction
  p1 <- make_predictions(model_o1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_o2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  #p3 <- make_predictions(model_o3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  #p4 <- make_predictions(model_o4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_o3 <- annotate_figure(ggarrange(p1,p2, nrow = 1, ncol = 2), top = text_grob("O3 Residuals", face = "bold", size = 16))
  
  # pm10 Level prediction
  p1 <- make_predictions(model_p1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_p2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  #p3 <- make_predictions(model_p3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  #p4 <- make_predictions(model_p4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_pm10 <- annotate_figure(ggarrange(p1,p2, nrow = 1, ncol = 2), top = text_grob("PM10 Residuals", face = "bold", size = 16))
  
  # pm25 Level prediction
  p1 <- make_predictions(model_p.1, data %>% filter(City == "Kolkata")) + ggtitle("Kolkata")
  p2 <- make_predictions(model_p.2, data %>% filter(City == "Delhi")) + ggtitle("Delhi")
  #p3 <- make_predictions(model_p.3, data %>% filter(City == "Muzaffarnagar")) + ggtitle("Muzaffarnagar")
  #p4 <- make_predictions(model_p.4, data %>% filter(City == "Mumbai")) + ggtitle("Mumbai")
  
  res_pm25 <- annotate_figure(ggarrange(p1,p2, nrow = 1, ncol = 2), top = text_grob("PM25 Residuals", face = "bold", size = 16))
  
  return(annotate_figure(ggarrange(res_so2, res_no2, res_co, res_o3, res_pm10, res_pm25, ncol = 2), top = text_grob("Residuals", face = "bold", size = 18)))
}
```

1.  Model Based on 2019

```{r Model_2019, warning=FALSE, message=FALSE, fig.asp=1.3, fig.width=16.2}
p1 <- present_model_summary(air_data_india_All_Specie_Daily_Regress %>% filter(Year == 2019), city_name = "Kolkata")
p2 <- present_model_summary(air_data_india_All_Specie_Daily_Regress %>% filter(Year == 2019), city_name = "Delhi")

annotate_figure(ggarrange(p1, p2, nrow = 2), top = text_grob("2019 Models", face = "bold", size = 16))
```

I have presented here the models for Kolkata and Delhi only. Other models for other cities will be attached at the end if interested to take a look at them. We have fit a **MLR model with each pollutants as the response and the weather parameters as the predictors** and similarly to figure out the strong relationship between the pollutants among themselves we have fit a separate **MLR model considering only the other pollutant's Levels**. The reason behind splitting the year into 2 parts are as can be seen from the visual overview section the **first half of the year has weather parameter levels much different from that of the second half** and the second reason being **we have data for the year 2021 till first 6 months only so fitting a model for the first half of the year will help us compare it with the year 2021**.

We see an interesting thing that is in the **first half of the year, the weather parameters are able to explain the pollutant Levels much better compared to that of the second half**. The **strength of the relationship of Pollutant Levels on other Pollutant Levels remains almost similar during both halves of the year. Temperature, Humidity and Dew have high significant effect throughout the year in explaining the Pollutant Levels throughout the year, which can be due to the intricate physical relationship that exists between this quantities i.e. concentration of gas being directly proportional to temperature, etc.**

The confidence intervals are mentioned under each coefficient giving us information about it's significance of being present in the model.

-   How well will take a look at *how the residuals of the above mentioned models are spread*
